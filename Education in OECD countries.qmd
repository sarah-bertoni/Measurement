------------------------------------------------------------------------

---
title: "Homework VI"
author: "Sarah Bertoni"
date: 28 February 2025
format:
  pdf: 
    fontsize: 9pt
    mainfont: Garamond
    sansfont: Garamond
editor: visual
output: 
  html_document:
    theme: cosmo
    latex_engine: pdflatex
    huxreg_options: "tabular={l|ccc}, tablewidth=0.1\\textwidth, tablefont=\\footnotesize"
    fig_caption: true
execute:
  echo: false
  warning: false
prefer-html: true
---

```{r}
library("modelsummary")
library("haven")
library("tidyverse")
library("kableExtra")
library("stargazer")
library("huxtable")
library("knitr")
library("spatstat")
library("gridExtra")
library(tinytable)
```

# 

```{r setup, include=FALSE}
if (!require("pacman")) install.packages("pacman") 
pacman::p_load(tidyverse, dplyr, knitr, haven, ggplot2, kableExtra, dplyr, gtsummary,gridExtra, stargazer)
```

# Education in France

## 1 Distribution of test scores and summary stats

```{r, fig.width=7, fig.height=5}
fe_data <- read_dta("panel97.dta")

mean_t1 <- mean(fe_data$gscore_t1, na.rm = TRUE)
mean_t2 <- mean(fe_data$gscore_t2, na.rm = TRUE)
mean_t3 <- mean(fe_data$gscore_t3, na.rm = TRUE)

mean_matht2 <- mean(fe_data$mscore_t2, na.rm = TRUE)
mean_matht3 <- mean(fe_data$mscore_t3, na.rm = TRUE)

mean_lit2 <- mean(fe_data$fscore_t2, na.rm = TRUE)
mean_lit3 <- mean(fe_data$fscore_t3, na.rm = TRUE)

#global scores density
global_graph =ggplot(fe_data) +
  geom_density(aes(x = gscore_t1, color = "Global Score (1997)", fill = "Global Score (1997)"), alpha = 0.4) +
  geom_density(aes(x = gscore_t2, color = "Global Score (1999/2000)", fill = "Global Score (1999/2000)"), alpha = 0.4) +
  geom_density(aes(x = gscore_t3, color = "Global Score (2002/2003)", fill = "Global Score (2002/2003)"), alpha = 0.4) +
  geom_vline(aes(xintercept = mean_t1, color = "Global Score (1997)"), linetype = "dashed") +
  geom_vline(aes(xintercept = mean_t2, color = "Global Score (1999/2000)"), linetype = "dashed") +
  geom_vline(aes(xintercept = mean_t3, color = "Global Score (2002/2003)"), linetype = "dashed") +
  theme_minimal() +
  labs(title = "Density Plot of Global Scores", x = "Score", y = "Density") +
  scale_color_manual(name = "Legend", values = c("Global Score (1997)" = "pink2", 
                                                 "Global Score (1999/2000)" = "palegreen2", 
                                                 "Global Score (2002/2003)" = "steelblue2")) +
  scale_fill_manual(name = "Legend", values = c("Global Score (1997)" = "pink2", 
                                                "Global Score (1999/2000)" = "palegreen2", 
                                                "Global Score (2002/2003)" = "steelblue2"))+theme(
    plot.title = element_text(size = 9),     
    plot.subtitle = element_text(size = 7),  
    plot.caption = element_text(size = 7),
     axis.title.x = element_text(size = 6),
     axis.title.y = element_text(size=6),
    legend.text = element_text(size = 6),
        legend.title = element_text(size = 7)) 


#literacy scores
lit_graph = ggplot(fe_data) +
  geom_density(aes(x = fscore_t2, color = "Lit. Score (1999/2000)", fill = "Lit. Score (1999/2000)"), alpha = 0.4) +
  geom_density(aes(x = fscore_t3, color = "Lit. Score (2002/2003)", fill = "Lit. Score (2002/2003)"), alpha = 0.4) +
  geom_vline(aes(xintercept = mean_lit2, color = "Lit. Score (1999/2000)"), linetype = "dashed") +
  geom_vline(aes(xintercept = mean_lit3, color = "Lit. Score (2002/2003)"), linetype = "dashed") +
  theme_minimal() +
  labs(title = "Density Plot of Lit. Scores", x = "Score", y = "Density") +
  scale_color_manual(name = "Legend", values = c("Lit. Score (1999/2000)" = "cyan4", 
                                                 "Lit. Score (2002/2003)" = "orchid4")) +
  scale_fill_manual(name = "Legend", values = c("Lit. Score (1999/2000)" = "cyan4", 
                                                 "Lit. Score (2002/2003)" = "orchid4")) +theme(
    plot.title = element_text(size = 9),     
    plot.subtitle = element_text(size = 7),  
    plot.caption = element_text(size = 7),
     axis.title.x = element_text(size = 6),
     axis.title.y = element_text(size=6),
    legend.text = element_text(size = 6),
        legend.title = element_text(size = 7)) 

#math scores
math_graph = ggplot(fe_data) +
  geom_density(aes(x = mscore_t2, color = "Lit Score (1999/2000)", fill = "Math Score (1999/2000)"), alpha = 0.4) +
  geom_density(aes(x = mscore_t3, color = "Math Score (2002/2003)", fill = "Math Score (2002/2003)"), alpha = 0.4) +
  geom_vline(aes(xintercept = mean_matht2, color = "Math Score (1999/2000)"), linetype = "dashed") +
  geom_vline(aes(xintercept = mean_matht3, color = "Math Score (2002/2003)"), linetype = "dashed") +
  theme_minimal() +
  labs(title = "Density Plot of Math Scores", x = "Score", y = "Density") +
  scale_color_manual(name = "Legend", values = c("Math Score (1999/2000)" = "salmon2", 
                                                 "Math Score (2002/2003)" = "forestgreen")) +
  scale_fill_manual(name = "Legend", values = c("Math Score (1999/2000)" = "salmon2", 
                                                 "Math Score (2002/2003)" = "forestgreen")) +theme(
    plot.title = element_text(size = 9),     
    plot.subtitle = element_text(size = 7),  
    plot.caption = element_text(size = 7),
     axis.title.x = element_text(size = 6),
     axis.title.y = element_text(size=6),
    legend.text = element_text(size = 6),
        legend.title = element_text(size = 7)) 

grid.arrange(global_graph, lit_graph, math_graph)

```


```{r}
scoresd <- fe_data%>%
  select("gscore_t1", "gscore_t2", "gscore_t3", 
              "fscore_t2", "mscore_t2", "fscore_t3", "mscore_t3")

#Method 1 to compare distribution: table with min, max, mean, SD, etc...
scores <- data.frame(
    Variable = names(scoresd),
    Min = sapply(scoresd, function(x) min(x,  na.rm = TRUE) ),
    P25 = sapply(scoresd, function(x) quantile(x, 0.25,  na.rm = TRUE) ),
    Mean = sapply(scoresd, function(x) mean(x,  na.rm = TRUE) ),
    Median = sapply(scoresd, function(x) median(x,  na.rm = TRUE) ),
    P75 = sapply(scoresd, function(x) quantile(x, 0.75,  na.rm = TRUE) ),
    Max = sapply(scoresd, function(x) max(x, na.rm = TRUE) ),
    Std.dev = sapply(scoresd, function(x) sd(x, na.rm = TRUE) ), 
    row.names = NULL
  )%>%
  mutate(
    across(where(is.numeric), round, 1),
    Year = (sapply(strsplit(Variable, "_t"), "[[", 2)),
    test = (sapply(strsplit(Variable, "_t"), "[[", 1)), 
    order = case_when(
      test == "gscore" ~ 1,
      test == "fscore" ~ 2,
      test == "mscore" ~ 3)
    )%>%
  arrange(order, Year)%>%
  select(test, Year, Min, P25, Mean, Median, P75, Max, Std.dev)

kable(scores[-1], 
      caption = "Summary of test scores",
      #col.names = c(names(scores)),
      align = "c") %>%
      group_rows("Global scores", 1, 2) %>%  
      group_rows("Literacy scores", 4, 5)  %>%
      group_rows("Math scores", 6, 7 )  %>%
  kable_styling(full_width = F, 
                position = "center") %>%  kable_classic_2()
    
```

## 2 Missing values


```{r echo=FALSE, message=FALSE, warning=FALSE}
na_counts <- fe_data %>%
  summarise(
    `1997` = sum(is.na(gscore_t1)),
    `1999/2000` = sum(is.na(gscore_t2)),
    `2002/2003` = sum(is.na(gscore_t3)),
    `1999/2000 ` = sum(is.na(mscore_t2)),
    `2002/2003 ` = sum(is.na(mscore_t3)),
    `1999/2000  ` = sum(is.na(fscore_t2)),
    `2002/2003  `= sum(is.na(fscore_t3))
  ) %>%
  t() %>%
  as.data.frame()

colnames(na_counts) <- "Missing Values"
na_counts <- cbind(Test_Score = rownames(na_counts), na_counts)
rownames(na_counts) <- NULL

kable(na_counts, caption = "Missing values of test score", digits = 2)%>%
  kable_classic_2(full_width = F, html_font = "Garamound") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>%
  row_spec(0, bold = T)  %>% 
    column_spec(2, bold = T) %>% pack_rows("Global",1,3)%>%
 pack_rows("Math",4,6) %>%
 pack_rows("Literature",6,7)
```

## 3 Global score after 3 years against the entry score

**Plot the global score after 3 years against the entry score**

The graph shows the correlation between students' global score in the entry test in the x axis and after three years.

```{r, fig.width=4.5, fig.height=4}
ggplot(fe_data, aes(x = gscore_t1, y = gscore_t2)) + 
  geom_point(alpha = 0.4, color="wheat3") + 
  geom_smooth(color="wheat4") +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "brown") +
  ggtitle("Global Score After 3 Years vs Initial Score") + 
  xlab("Initial Global Score") + 
  ylab("Global Score After 3 Years") + 
  theme_minimal() +theme(
    plot.title = element_text(size = 9),     
    plot.subtitle = element_text(size = 7),  
    plot.caption = element_text(size = 7),
     axis.title.x = element_text(size = 6),
     axis.title.y = element_text(size=6),
    legend.text = element_text(size = 6),
        legend.title = element_text(size = 7)) 
```


```{r}

model<-fe_data %>%  mutate("Entry score"=gscore_t1)
model <-  lm(gscore_t3 ~ `Entry score`, data=model)

model <- huxreg("Dependent variable: score after 3 years" = model,
                  error_format = "({std.error})",
                  error_pos = "below",
                  statistics = c(N = "nobs"),
                  note = "{stars}",
                  align = "center") %>%
  set_caption("Correlation between test scores")
set_latex_float(model, value = "H")
```

## 4 Analyzing progress


We can measure a pupil's progress between the first and the third year and between the third year and the final year of primary school either by looking at absolute or relative scores.

To observe changes in absolute terms we could merely calculate them as the difference between the scores in two test periods: $\Delta \text{Score} = \text{Score}_{t2} - \text{Score}_{t1}$

However, to understand the intensity of the change in test scores it may be useful to observe the decile ranks and compute $\Delta d\_gscore = d\_gscore_{t2} - d\_gscore_{t1}$ .

Positive changes in deciles $\Delta d\_gscore > 0$ indicate improvements relative to other students, while $\Delta d\_gscore < 0$ indicate a shift downwards in the score distribution, and $\Delta d\_gscore = 0$ implies that the pupil remained in the same decile.

We compute the relative change of the score of the pupil relative to the whole distribution by plotting the difference between the decile to which the student belongs in the two periods.



```{r, fig.width=4, fig.height=4}

 fe_data <- fe_data %>% mutate(delta_d_gscore_1_2 = d_gscore_t2 - d_gscore_t1,  #decile change year 1 - year 3
    delta_d_gscore_2_3 = d_gscore_t3 - d_gscore_t2) #decile change final year - year 3

p1 = ggplot(fe_data, aes(x = delta_d_gscore_1_2)) + 
  geom_bar(fill = "darkgrey", alpha = 0.7) + 
  ggtitle("Distribution of Progress (Decile Change: Year 1 to Year 3)") + 
  xlab("Change in Decile") + 
  ylab("Number of Students") + 
  theme_minimal() +theme(
    plot.title = element_text(size = 9),     
    plot.subtitle = element_text(size = 7),  
    plot.caption = element_text(size = 7),
     axis.title.x = element_text(size = 6),
     axis.title.y = element_text(size=6),
    legend.text = element_text(size = 6),
        legend.title = element_text(size = 7)) 

p2 = ggplot(fe_data, aes(x = delta_d_gscore_2_3)) + 
  geom_bar(fill = "ivory3", alpha = 0.7) + 
  ggtitle("Distribution of Progress (Decile Change: Year 3 to Final Year)") + 
  xlab("Change in Decile") + 
  ylab("Number of Students") + 
  theme_minimal() +theme(
    plot.title = element_text(size = 9),     
    plot.subtitle = element_text(size = 7),  
    plot.caption = element_text(size = 7),
     axis.title.x = element_text(size = 6),
     axis.title.y = element_text(size=6),
    legend.text = element_text(size = 6),
        legend.title = element_text(size = 7)) 

grid.arrange(p1, p2)

```

**b) Summary stats of decile differences**

```{r}
sum_stats_decile <- fe_data %>%
  select(delta_d_gscore_1_2, delta_d_gscore_2_3)

sum_stats_table_decile <- data.frame(
  Statistic = c("Mean", "SD", "Min", "Max", "N Obs"),
  sapply(sum_stats_decile, function(x) c(
    mean = mean(x, na.rm = TRUE),
    sd = sd(x, na.rm = TRUE),
    min = min(x, na.rm = TRUE),
    max = max(x, na.rm = TRUE),
    n_obs = sum(!is.na(x))
  ))
)

colnames(sum_stats_table_decile) <- c("Statistic", "(Y1-Y3)", "(Y3-Final)")
rownames(sum_stats_table_decile) <- NULL


kable(sum_stats_table_decile, caption = "Summary Statistics of Decile Change", digits = 2)%>%
  kable_classic_2(full_width = F, html_font = "Garamound") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>%
  row_spec(0, bold = T)  %>% 
    column_spec(2:3, bold = T) 



```

## 5 Mobility between two successive tests in deciles

**Compute transition matrices across deciles of the global score distribution between test 1 and test 2,then between test 2 and test 3**



```{r, fig.width=4, fig.height=4}
matrix21 <- fe_data %>%
  drop_na()%>%
  select(d_gscore_t1, d_gscore_t2) %>%
  group_by(d_gscore_t1) %>%
  mutate(n_den=n()) %>%
  group_by(d_gscore_t1, d_gscore_t2, n_den) %>%
  summarise(n_nom = n())%>%
  mutate(p = n_nom / n_den *100)%>%
  select (-c(n_nom, n_den))
# pivot_wider( names_from=d_gscore_t2, values_from=p)%>%
#  mutate(across(where(is.numeric), round, 0))

matrix21_grph <-ggplot(matrix21, aes(x = as.factor(d_gscore_t1), y = as.factor(d_gscore_t2), fill = p)) +
  geom_tile(color = "white") +
  geom_text(aes(label = round(p, 1)), color = "black", size = 4) +  
  scale_fill_gradient(low = "snow", high = "lightblue4", name = NULL) +  # Removes legend title
  labs(title = "Heatmap of Decile Rank Transitions",
       x = "Decile rank on test 1",
       y = "Decile rank on test 2") +  # No label for 'fill'
  theme_minimal()+
  theme(legend.position = "none")+theme(
    plot.title = element_text(size = 8),     
    plot.subtitle = element_text(size = 7),  
    plot.caption = element_text(size = 7),
     axis.title.x = element_text(size = 6),
     axis.title.y = element_text(size=6),
    legend.text = element_text(size = 6),
        legend.title = element_text(size = 7))

matrix32 <- fe_data %>%
  drop_na()%>%
  select(d_gscore_t2, d_gscore_t3) %>%
  group_by(d_gscore_t2) %>%
  mutate(n_den=n()) %>%
  group_by(d_gscore_t2, d_gscore_t3, n_den) %>%
  summarise(n_nom = n())%>%
  mutate(p = n_nom / n_den *100)%>%
  select (-c(n_nom, n_den)) 
#  pivot_wider( names_from=d_gscore_t3, values_from=p)%>%
#  mutate(across(where(is.numeric), round, 0))

matrix32_grph <- ggplot(matrix32, aes(x = as.factor(d_gscore_t2), y = as.factor(d_gscore_t3), fill = p)) +
  geom_tile(color = "white") +
  geom_text(aes(label = round(p, 1)), color = "black", size = 4) +  
  scale_fill_gradient(low = "ivory", high = "khaki4", name = NULL) +  # Removes legend title
  labs(title = "Heatmap of Decile Rank Transitions",
       x = "Decile rank on test 2",
       y = "Decile rank on test 3") +  # No label for 'fill'
  theme_minimal()+
  theme(legend.position = "none")+theme(
    plot.title = element_text(size = 8),     
    plot.subtitle = element_text(size = 7),  
    plot.caption = element_text(size = 7),
     axis.title.x = element_text(size = 6),
     axis.title.y = element_text(size=6),
    legend.text = element_text(size = 6),
        legend.title = element_text(size = 7)) 

grid.arrange(matrix21_grph, matrix32_grph, ncol = 1, nrow=2)

```

## 6 Birth date and scores

#### a) Global test scores of pupils by Month of Birth

We compare test scores espressed in deciles between pupils born in January and in December across the three global scores, showcasing the 95% confidence interval for the difference between the average scores of the two categories.

```{r}
means_birth <- fe_data %>% 
  select(birthm, d_gscore_t1, d_gscore_t2, d_gscore_t3) %>% 
  pivot_longer(
    cols = starts_with("d_gscore_"),      # Select columns to pivot
    names_to = "test",            # Name for the new key column
    values_to = "value"               # Name for the new value column
  )%>%
  group_by(birthm, test)%>%
  summarise(
    n = n(),
    mean = mean(value,  na.rm = TRUE),
    sd = sd(value,  na.rm = TRUE)
  )%>%
  filter(birthm==1 | birthm == 12)%>%
  mutate(
    birthm = recode(birthm, "1" = "A", "12" = "B"), #Category A= born in Jan.
    type = "Birth")%>%
  rename( cat = birthm) 

means_occ <- fe_data %>% 
  select(parent_occ, d_gscore_t1, d_gscore_t2, d_gscore_t3) %>% 
  pivot_longer(
    cols = starts_with("d_gscore_"),      # Select columns to pivot
    names_to = "test",            # Name for the new key column
    values_to = "value"               # Name for the new value column
  )%>%
  group_by(parent_occ, test)%>%
  summarise(
    n = n(),
    mean = mean(value,  na.rm = TRUE),
    sd = sd(value,  na.rm = TRUE)
  )%>%
  filter(parent_occ== 3 |  parent_occ== 6)%>%
  mutate( parent_occ = as.character(parent_occ),
    parent_occ = recode(parent_occ, `3` = "A", `6` = "B"), #Category A=parents are executives
    type = "Occupation")%>% 
  rename( cat = parent_occ)

#Merge both datasets 
means <- rbind(means_birth, means_occ) %>%
  pivot_wider(names_from=cat, values_from=c(n, sd, mean))%>%
  mutate(
    SE_A = sd_A/sqrt(n_A),
    SE_B = sd_B/sqrt(n_B),
    diff = mean_A-mean_B,
    SE_diff = sqrt( ((sd_A^2)/n_A) + ((sd_B^2)/n_B) ),
    CI_lower = diff-1.96*SE_diff,
    CI_upper = diff+1.96*SE_diff,
         Year = (sapply(strsplit(test, "_t"), "[[", 2)),) %>% mutate(test=recode(test,d_gscore_t1="Global test 1", d_gscore_t2="Global test 2",d_gscore_t3 ="Global test 3"))
    
    kable(
  means[means$type=='Birth', c("test", "mean_A", "mean_B", "diff", "CI_lower", "CI_upper")] %>% 
    mutate(across(c(mean_A, mean_B, diff, CI_lower, CI_upper), 
                  ~ format(round(.x, 1), nsmall = 1))),  
  caption = "Difference in average deciles of pupils born in January and December - global score",
  col.names = c("Test", "January", "December", "Difference", "Lower CI", "Upper CI"),
  align = "c",
  booktabs = TRUE,
  longtable = TRUE
)   %>%
  kable_styling(full_width = F, position = "center",latex_options = c("hold_position")) %>%
  footnote(general = "Differences are calculated as Mean A - Mean B. CI represents a 95% confidence interval.",
           threeparttable = TRUE) %>% kable_classic_2()  
```


```{r, fig.width=4, fig.height=4}

birth <- means %>%
  filter(type == "Birth") %>%  # Filter only for Birth category
  select(test, mean_A, mean_B, SE_A, SE_B) %>%
  pivot_longer(cols = c(mean_A, mean_B, SE_A, SE_B), 
               names_to = c("Metric", "Group"), 
               names_pattern = "(mean|SE)_(A|B)") %>%
  pivot_wider(names_from = "Metric", values_from = "value") %>%
  mutate(Group = ifelse(Group == "A", "January", "December"))

ggplot(birth, aes(x = test, y = mean, fill = Group)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.7), width = 0.6) +
  geom_errorbar(aes(ymin = mean - 1.96*SE, ymax = mean + 1.96*SE), 
                position = position_dodge(width = 0.7), width = 0.2) +
  scale_fill_manual(values = c("January" = "wheat4", "December" = "wheat")) +
  scale_x_discrete(labels = c("d_gscore_t1" = "Global Test 1", 
                              "d_gscore_t2" = "Global Test 2", 
                              "d_gscore_t3" = "Global Test 3")) +
  labs(title = "Comparison of pupils deciles by Month of Birth - global score",
       x = NULL,  # Remove x-axis label
       y = "Mean Score",
       fill = "Birth Month") +
  theme_classic()+
  theme(
    legend.position = "right",
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    axis.title = element_text(size = 12)
  )+theme(
    plot.title = element_text(size = 8),     
    plot.subtitle = element_text(size = 7),  
    plot.caption = element_text(size = 7),
     axis.title.x = element_text(size = 6),
     axis.title.y = element_text(size=6),
    legend.text = element_text(size = 6),
        legend.title = element_text(size = 7)) 
```

#### b) Global test scores of pupils born in Jan vs december given parents' occupation



```{r}
 kable(
  means[means$type=='Occupation', c("test", "mean_A", "mean_B", "diff", "CI_lower", "CI_upper")] %>% 
    mutate(across(c(mean_A, mean_B, diff, CI_lower, CI_upper), 
                  ~ format(round(.x, 1), nsmall = 1))),  
  caption = "Difference in global test scores between children of executives and blue collars",
  col.names = c("Test", "Executive", "Blue Collars", "Difference", "Lower CI", "Upper CI"),
  align = "c",
  booktabs = TRUE,
  longtable = TRUE
)   %>%
  kable_styling(full_width = F, position = "center",latex_options = c("hold_position")) %>%
  footnote(general = "Differences are calculated as Mean A - Mean B. CI represents a 95% confidence interval.",
           threeparttable = TRUE) %>% kable_classic_2()
```

To better analyse the trend in deciles composition as a function of age and parents occupation we plot the differences by Birth and Parents occupation for each test. 

```{r, fig.width=4, fig.height=4}

ggplot(means, aes(x = test, y = diff, fill = type)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.7), width = 0.6) +
  geom_errorbar(aes(ymin = CI_lower, ymax = CI_upper), 
                position = position_dodge(width = 0.7), width = 0.2) +
  scale_fill_manual(values = c("Birth" = "wheat4", "Occupation" = "ivory2"),
                  labels = c("Birth" = "Month of Birth", "Occupation" = "Parents' Occupation")) +
   scale_x_discrete(labels = c("gscore_t1" = "Test 1", 
                              "gscore_t2" = "Test 2", 
                              "gscore_t3" = "Test 3")) +
  labs(title = "Difference in mean test scores by parents occupation",
       x = NULL,
       y = "Difference in Mean Scores",
       fill = "Difference by") +
  theme_classic()+
  theme(
    legend.position = "right",
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    axis.title = element_text(size = 12)
  )+theme(
    plot.title = element_text(size = 8),     
    plot.subtitle = element_text(size = 7),  
    plot.caption = element_text(size = 7),
     axis.title.x = element_text(size = 6),
     axis.title.y = element_text(size=6),
    legend.text = element_text(size = 6),
        legend.title = element_text(size = 7)) 
```



# Education in OECD countries

```{r}
pisa <- read_dta("pisa_2012.dta")
```

## 1 Missing values



```{r}
subsetscores <- pisa %>% select(c('PV1MATH', 'PV2MATH', 'PV3MATH','PV4MATH','PV5MATH', 'PV1READ', 'PV2READ','PV3READ','PV4READ','PV5READ',	PV1SCIE, PV2SCIE, PV3SCIE, PV4SCIE, PV5SCIE))


 kable((sapply(subsetscores, function(na) {sum(is.na(na))})), caption = "Missing values of Plausible Values", col.names=c("PV", "NAs")) %>%
  kable_classic_2(full_width = F, html_font = "Garamound") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))  %>%
  row_spec(0, bold = T)  %>% 
    column_spec(2, bold = T) %>% pack_rows("Mathematics",1,5)%>%
 pack_rows("Reading",6,11) %>%
 pack_rows("Science",11,15)
```


```{r}



nas <- pisa %>%
  summarise(across(everything(), ~ round(sum(is.na(.)) / nrow(pisa) * 100, 3))) %>%
  pivot_longer(everything(), names_to = "Column", values_to = "Nas") %>%
  mutate(Label = sapply(Column, function(col) { 
    label <- attr(pisa[[col]], "label")
    if (!is.null(label)) label else col  # If no label, use column name
  })) %>%
  filter(Nas > 0)

kable(nas[, c(1,3,2)], caption = "Percentage of Missing values", col.names=c("PV","Label", "NAs"))%>%
  kable_classic_2(full_width = F, html_font = "Garamound") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))


```

## 2 Plausible Values


PISA applies a two stage sampling: schools are first sampled and then students are sampled in the participating schools. As a result, two set of weights are used. To estimate student perfomarce PISA uses imputation methods - plausible values. Plausible values are used to obtain unbiased estimates of the parameters, as they are random draws from the estimated distribution of each student's ability. Multiple PV are imputed for each student; relative statistical analyses are independently performed on each of these five plausible values and results are then aggregated to obtain the final estimates of the statistics and their respective standard errors. Consequently, in the estimation of a parameter (eg. a mean) such parameter has to be computed 405 times (i.e. 5 plausible values by one student final weights and 80 replicates) to obtain the final estimate of the parameter and its standard error.

**Function**:

1.  For each plausible value k, the weighted mean is computed using the corresponding replication weight across the 80 replications (as we previously explained, PISA uses two stage stratified sampling). Results are stored in the matrix R.mean, where rows correspond to the replication weights, and columns correspond to the plausible values.

2.  For each plausible value it computes the weighted mean using final student weights and the result is stored in a vector PV.mean.

3.  It computes the average of the plausible value statistical estimates using final weight across all PV.mean (the average of all the weighted means from the previous step) and saves them in MEAN.m.

4.  This step estimates within and between imputation variance.

    *Within group variance*: For each plausible value (i), it calculates the weighted variance between the replications' means (R.mean\[, i\]) and the final weighted mean of the PV (PV.mean\[i\]). This variance is scaled by a factor cc = 1/20 to used to adjust for the number of replication weights. To account for the variation, the within variance is computed using bootstrapping; the 80 replication simulate 80 distribution form which standard errors are estimated and the variance is then computed.

The computation of standard error for PISA follows the Fay's variant of the Balanced Repeated Replication (BRR) method. Since PISA includes 80 replications and the Fay coefficient is set to 0.5, the standard error can be estimate as follow:

$$
{\sigma}^2_{\hat{\theta}}= \frac{1}{G(1-k)^2}\sum_{i=1}^G(\hat{\theta}_{(i)}-\hat{\theta})^2
$$

$$
\Longrightarrow{\sigma}^2_{\hat{\theta}}=  \frac{1}{80(1-0.5)^2}\sum_{i=1}^80(\hat{\theta}_{(i)}-\hat{\theta})^2
$$

$$
= \frac{1}{20}\sum_{i=1}^{80}(\hat{\theta}_{(i)}-\hat{\theta})^2
$$

*Between groups variance:* This calculates the between-imputation variance by computing the variance between each plausible value's mean (PV.mean\[i\]) and the overall mean across every PV (MEAN.m); the variance is adjusted by dividing by the number of plausible values minus 1, similarly to a degrees of freedom correction.

5.  Standard errors are computed by combining the within-imputation variance and the between-imputation variance and adjusting the between variance by a factor $$(1 + \frac{1}{\text{number of pv name - 1}})$$.

6.  95% confidence intervals are calculated.

7.  A data frame is returned containing the number of observations, the mean of the plausible values (MEAN.m), the standard error of the mean and the 95% confidence intervals with relative upper and lower bound.

```{r}
 
 
 # Set of Plausible values
 pvmath <- c("PV1MATH", "PV2MATH", "PV3MATH", "PV4MATH", "PV5MATH")
 pvread <- c("PV1READ", "PV2READ", "PV3READ", "PV4READ", "PV5READ")
 pvscie <- c("PV1SCIE", "PV2SCIE", "PV3SCIE", "PV4SCIE", "PV5SCIE")
 
subjects <- list("Math" = pvmath, "Reading" = pvread, "Science" = pvscie)

countries <- list("Finland", "Viet Nam", "Norway", "France")

```

```{r}

#function
#>>> Parameters >>>

pisa_config <- list("variables","parameters")
pisa_config$variables$weightFinal<-"WEIGHT"
pisa_config$variables$weightBRR <-"W_FSTR"
pisa_config$parameters$BRRreps <- as.numeric(80) # number of replication weights

#>>> Functions >>>

#>>> Mean estimation for plausible values

fun.pv <- function (pvnames, data, folder = getwd()) {
 
    R.mean <- sapply(pvnames, function(k) sapply(1:pisa_config$parameters$BRRreps, 
                                                 function(i) weighted.mean(data[[k]], 
                                                                           data[[paste0(pisa_config$variables$weightBRR,i)]], na.rm = TRUE)))
    PV.mean <- sapply(pvnames, function(x) weighted.mean(data[[x]], 
                                                         data[[pisa_config$variables$weightFinal]], na.rm = TRUE))
    MEAN.m <- mean(PV.mean)
    cc = 1/20
    
    var.mean.w <- mean(sapply(seq_along(pvnames), function(i) cc *sum((R.mean[, i] - PV.mean[i])^2)))
    
    var.mean.b <- (1/(length(pvnames) - 1)) * sum(sapply(seq_along(pvnames), function(i) (PV.mean[i] - MEAN.m)^2)) 
    
    mean.se <- (var.mean.w + (1 + 1/length(pvnames)) * var.mean.b)^(1/2)
    
    LB <- MEAN.m - 1.96*mean.se
    UB <- MEAN.m + 1.96*mean.se
    
    result <- data.frame(Freq = length(data[[pisa_config$variables$weightFinal]]), 
                         Mean = mean(MEAN.m), s.e. = mean.se, LB = LB, UB = UB)
    
    return(round(result, 2))
}
```

```{r}

# dataframe
final <- data.frame(Country = character(),
                       Subject = character(),
                       Mean = numeric(),
                       s.e. = numeric(),
                       stringsAsFactors = FALSE)

# Apply the function
for (country in countries) {
  for (subjects_name in names(subjects)) {
    
    
    pvnames <- subjects[[subjects_name]]
    
    # Apply the fun function to the data for the given country and variable
    result <- fun.pv(pvnames, pisa[(pisa$CNT == country), ], folder = getwd())
    
    # Add the result (mean and s.e.) to the data frame
    temp_df <- data.frame(Country = country,
                          Subject = subjects_name,
                          Mean = result$Mean,
                          s.e. = result$s.e.,
                          stringsAsFactors = FALSE)
    
    # Bind the result to the final data frame
    final <- rbind(final, temp_df)
  }
}


```

```{r}
##Kable
final %>% pivot_longer(cols = c("Mean", "s.e."), names_to = "Metric", values_to = "Value") %>%
mutate(
Value = ifelse(Metric == "s.e.", paste0("(", round(Value, 2), ")"), round(Value, 2)), 
Metric = ifelse(Metric == "Mean", "Estimate", "SE") # Rename metric
) %>%
pivot_wider(names_from = "Country", values_from = "Value") %>%
mutate("Subject" = ifelse(Metric == "SE", "", Subject)) %>% 
select(-Metric) %>% kable() %>%
  kable_classic_2(full_width = F, html_font = "Garamound") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))  %>%
  row_spec(0, bold = T) 
```

## 3 Gender


```{r}
##Girls
# dataframe
final_girls <- data.frame(Country = character(),
                       Subject = character(),
                       Mean = numeric(),
                       s.e. = numeric(),
                       stringsAsFactors = FALSE)

# Apply the function
for (country in countries) {
  for (subjects_name in names(subjects)) {
  
    
    pvnames <- subjects[[subjects_name]]
    
   
    result_girls <- fun.pv(pvnames, pisa[(pisa$CNT == country & pisa$GENDER==0), ], folder = getwd())
    
   
    temp_df <- data.frame(Country = country,
                          Subject = subjects_name,
                          Mean = result_girls$Mean,
                          s.e. = result_girls$s.e.,
                          stringsAsFactors = FALSE)
    
  
    final_girls <- rbind(final_girls, temp_df)
  }
}

final_girls <- final_girls %>%  mutate(Gender= "Girls")

## Boys

final_boys <- data.frame(Country = character(),
                       Subject = character(),
                       Mean = numeric(),
                       s.e. = numeric(),
                       stringsAsFactors = FALSE)

# Apply the function
for (country in countries) {
  for (subjects_name in names(subjects)) {

        pvnames <- subjects[[subjects_name]]
    
    # Apply the fun function to the data for the given country and variable
    result_boys <- fun.pv(pvnames, pisa[(pisa$CNT == country & pisa$GENDER==1), ], folder = getwd())
    
    
    
    temp_df_boys <- data.frame(Country = country,
                          Subject = subjects_name,
                          Mean = result_boys$Mean,
                          s.e. = result_boys$s.e.,
                          stringsAsFactors = FALSE)
    
    # Bind the result to the final data frame
    final_boys <- rbind(final_boys, temp_df_boys)
  }
}

final_boys <- final_boys %>%  mutate(Gender= "Boys")

## Combine
final_df <- rbind(final_boys, final_girls)

final_df <- final_df %>% pivot_longer(cols = c("Mean", "s.e."), names_to = "Metric", values_to = "Value") %>%
mutate(
Value = ifelse(Metric == "s.e.", paste0("(", round(Value, 2), ")"), round(Value, 2)), 
Metric = ifelse(Metric == "Mean", "Estimate", "SE")
) %>%
pivot_wider(names_from = "Country", values_from = Value) %>%
mutate("Subject" = ifelse(Metric == "SE", "", Subject)) 

final_df %>% 
select(-Metric, -Gender)%>% kable() %>%
  kable_classic_2(full_width = F, html_font = "Garamound") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))  %>%
  row_spec(0, bold = T) %>% pack_rows("Boys",1,6)%>%
 pack_rows("Girls",7,12)

```

```{r}
#Individual Mean values
## Girls
## math
Finland_girls <- fun.pv(pvmath, pisa[(pisa$CNT=="Finland"& pisa$GENDER==0),], folder = getwd())
France_girls <- fun.pv(pvmath, pisa[(pisa$CNT=="France"& pisa$GENDER==0),], folder = getwd())
Norway_girls <- fun.pv(pvmath, pisa[(pisa$CNT=="Norway"& pisa$GENDER==0),], folder = getwd())
Vietnam_girls <- fun.pv(pvmath, pisa[(pisa$CNT=="Viet Nam"& pisa$GENDER==0),], folder = getwd())



##read

Finland_r_girls <- fun.pv(pvread, pisa[(pisa$CNT=="Finland"& pisa$GENDER==0),], folder = getwd())
France_r_girls <- fun.pv(pvread, pisa[(pisa$CNT=="France"& pisa$GENDER==0),], folder = getwd())
Norway_r_girls <- fun.pv(pvread, pisa[(pisa$CNT=="Norway"& pisa$GENDER==0),], folder = getwd())
Vietnam_r_girls <- fun.pv(pvread, pisa[(pisa$CNT=="Viet Nam"& pisa$GENDER==0),], folder = getwd())



##science

Finland_s_girls <- fun.pv(pvscie, pisa[(pisa$CNT=="Finland" & pisa$GENDER==0),], folder = getwd())
France_s_girls <- fun.pv(pvscie, pisa[(pisa$CNT=="France" & pisa$GENDER==0),], folder = getwd())
Norway_s_girls <- fun.pv(pvscie, pisa[(pisa$CNT=="Norway" & pisa$GENDER==0),], folder = getwd())
Vietnam_s_girls <- fun.pv(pvscie, pisa[(pisa$CNT=="Viet Nam" & pisa$GENDER==0),], folder = getwd())



```

```{r}
## boys
## math
Finland <- fun.pv(pvmath, pisa[(pisa$CNT=="Finland"& pisa$GENDER==1),], folder = getwd())
France <- fun.pv(pvmath, pisa[(pisa$CNT=="France"& pisa$GENDER==1),], folder = getwd())
Norway <- fun.pv(pvmath, pisa[(pisa$CNT=="Norway"& pisa$GENDER==1),], folder = getwd())
Vietnam <- fun.pv(pvmath, pisa[(pisa$CNT=="Viet Nam"& pisa$GENDER==1),], folder = getwd())


##read

Finland_r <- fun.pv(pvread, pisa[(pisa$CNT=="Finland"& pisa$GENDER==1),], folder = getwd())
France_r <- fun.pv(pvread, pisa[(pisa$CNT=="France"& pisa$GENDER==1),], folder = getwd())
Norway_r <- fun.pv(pvread, pisa[(pisa$CNT=="Norway"& pisa$GENDER==1),], folder = getwd())
Vietnam_r <- fun.pv(pvread, pisa[(pisa$CNT=="Viet Nam"& pisa$GENDER==1),], folder = getwd())


##science

Finland_s <- fun.pv(pvscie, pisa[(pisa$CNT=="Finland" & pisa$GENDER==1),], folder = getwd())
France_s <- fun.pv(pvscie, pisa[(pisa$CNT=="France" & pisa$GENDER==1),], folder = getwd())
Norway_s <- fun.pv(pvscie, pisa[(pisa$CNT=="Norway" & pisa$GENDER==1),], folder = getwd())
Vietnam_s <- fun.pv(pvscie, pisa[(pisa$CNT=="Viet Nam" & pisa$GENDER==1),], folder = getwd())


```

## 4 Difference in Gender

We compute the mean across all subjects of boys and girls and compare at the country level. 

```{r, fig.width=4, fig.height=3}


meanboys <- data.frame(
  Finland = mean(c(Finland_s$Mean, Finland_r$Mean, Finland$Mean)),
  France = mean(c(France$Mean, France_r$Mean, France_s$Mean)),
  Vietnam = mean(c(Vietnam$Mean, Vietnam_r$Mean, Vietnam_s$Mean)),
  Norway = mean(c(Norway$Mean, Norway_r$Mean, Norway_s$Mean))
, row.names = 'Boys')

meangirls <- data.frame(
  Finland = mean(c(Finland_s_girls$Mean, Finland_r_girls$Mean, Finland_girls$Mean)),
  France = mean(c(France_girls$Mean, France_r_girls$Mean, France_s_girls$Mean)),
  Vietnam = mean(c(Vietnam_girls$Mean, Vietnam_r_girls$Mean, Vietnam_s_girls$Mean)),
  Norway = mean(c(Norway_girls$Mean, Norway_r_girls$Mean, Norway_s_girls$Mean))
, row.names = 'Girls')

meangirls <- meangirls %>%  pivot_longer(cols= everything(), names_to = 'Country', values_to = 'Girls')
meanboys <- meanboys %>%  pivot_longer(cols= everything(), names_to = 'Country', values_to = 'Boys')

gender_comp <- left_join(meanboys, meangirls)

gender_comp_long <- gender_comp %>%
  pivot_longer(cols = c("Boys", "Girls"), 
               names_to = "Gender", 
               values_to = "Mean")

# Create the histogram
ggplot(gender_comp_long, aes(x = Country, y = Mean, fill = Gender, group = Gender)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Average Scores for Boys and Girls by Country",
       x = "Country", y = "Average score") +
  theme_minimal() +
  scale_fill_manual(values = c("beige", "grey")) +
  theme(
    legend.position = "right",
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    axis.title = element_text(size = 12)
  )+theme(
    plot.title = element_text(size = 8),     
    plot.subtitle = element_text(size = 7),  
    plot.caption = element_text(size = 7),
     axis.title.x = element_text(size = 6),
     axis.title.y = element_text(size=6),
    legend.text = element_text(size = 6),
        legend.title = element_text(size = 7)) 

```

#### Difference by Subject


```{r, fig.width=5.5, fig.height=4}
#Filter the data
data<-data.frame(final_df) %>%  filter(Metric=='Estimate') %>% select(-Metric)
data_long <- data %>%
  pivot_longer(cols = starts_with("Finland"):starts_with("France"), 
               names_to = "Country", 
               values_to = "Estimate")
data_long$Estimate <- as.numeric(data_long$Estimate)


#Plot the data by gender, subject and country

ggplot(data_long, aes(x = Subject, y = Estimate, color = Gender, shape = Gender)) +
  geom_segment(aes(x = Subject, xend = Subject, y = 0, yend = Estimate)) +
  geom_point(size = 3, alpha = 0.7) +
  facet_wrap(~ Country) +
  theme_light() +
  coord_flip() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank()
  ) +
  labs(title = "PISA values by Subject, Gender, and Country", x = "Subject", y = "PV")+
  scale_color_manual(values = c("Boys" = "wheat4", "Girls" = "wheat2")) +theme(
    plot.title = element_text(size = 8),     
    plot.subtitle = element_text(size = 7),  
    plot.caption = element_text(size = 7),
     axis.title.x = element_text(size = 6),
     axis.title.y = element_text(size=6),
    legend.text = element_text(size = 6),
        legend.title = element_text(size = 7)) 
```

## 5 Mean estimation for standard variables

**Function**

1.  It calculates the weighted mean for the specified variable across the 80 replication using replications weights.

2.  We calculate the weighted mean for the variable using the final weight.

3.  Standard errors are computed by taking the square root of the sum of squared differences between each of the replication means and the total mean previously computed; the sum of squared differences is multiplied by 0.05, given by the fact that there are 80 replicates and the Fay coefficient is set to 0.5.

4.  Finally, the 95% confidence interval is computed, and the function returns the relative lower and upper bound.


**Self assessment values across genders**



```{r}
self_ass <- list("Self-assessment" = "SCMAT",
"Anxiety" = "ANXMAT",
"Interest" = "INTMAT")

countries <- list("Finland", "Viet Nam", "Norway", "France")
```

```{r}
fun <- function(variable, data) {
  
  # Calculate BRR replication weights
  meanrp <- sapply(1:pisa_config$parameters$BRRreps, function(i) 
    weighted.mean(as.numeric(data[[variable]]), 
                  data[[paste(pisa_config$variables$weightBRR, i, sep = "")]], 
                  na.rm = TRUE)
  )
  
  # Calculate total weighted mean
  meantot <- weighted.mean(as.numeric(data[[variable]]), 
                           data[[pisa_config$variables$weightFinal]], na.rm = TRUE)
  
  # Compute the standard error
  meanse <- (0.05 * sum((meanrp - meantot)^2))^(1/2)
  
  # Compute confidence interval bounds
  LB <- meantot - 1.96 * meanse
  UB <- meantot + 1.96 * meanse
  
  # Return the results
  result <- data.frame( 
                       Mean = meantot, 
                       s.e. = meanse, 
                       LB = LB, 
                       UB = UB)
  
  return(round(result, 2))
} 

```

```{r}
##Girls

# Create an empty data frame to store the results
final_girls <- data.frame(Country = character(),
                       Variable = character(),
                       Mean = numeric(),
                       s.e. = numeric(),
                       stringsAsFactors = FALSE)

# Apply the 'fun' function and store the results in the data frame
for (country in countries) {
  for (variable_name in names(self_ass)) {
    # Get the variable code from the self_ass list
    variable_code <- self_ass[[variable_name]]
    
    # Apply the fun function to the data for the given country and variable
    result <- fun(variable_code, pisa[(pisa$CNT == country & pisa$GENDER==0), ])
    
    # Add the result (mean and s.e.) to the data frame
    temp_df <- data.frame(Country = country,
                          Variable = variable_name,
                          Mean = result$Mean,
                          s.e. = result$s.e.,
                          stringsAsFactors = FALSE)
    
    # Bind the result to the final data frame
    final_girls <- rbind(final_girls, temp_df)
  }
}
final_girls <- final_girls %>% mutate(Gender="Girls")


```

```{r}
##Boys

# Create an empty data frame to store the results
final_boys <- data.frame(Country = character(),
                       Variable = character(),
                       Mean = numeric(),
                       s.e. = numeric(),
                       stringsAsFactors = FALSE)

# Apply the 'fun' function and store the results in the data frame
for (country in countries) {
  for (variable_name in names(self_ass)) {
    # Get the variable code from the self_ass list
    variable_code <- self_ass[[variable_name]]
    
    # Apply the fun function to the data for the given country and variable
    result <- fun(variable_code, pisa[(pisa$CNT == country & pisa$GENDER==1), ])
    
    # Add the result (mean and s.e.) to the data frame
    temp_df_boys <- data.frame(Country = country,
                          Variable = variable_name,
                          Mean = result$Mean,
                          s.e. = result$s.e.,
                          stringsAsFactors = FALSE)
    
    # Bind the result to the final data frame
    final_boys <- rbind(final_boys, temp_df_boys)
  }
}

final_boys <- final_boys %>% mutate(Gender="Boys")

```

```{r}

## Bind dataframes
final_df <- rbind(final_boys, final_girls)

#Kable 

data <- final_df %>% pivot_longer(cols = c("Mean", "s.e."), names_to = "Metric", values_to = "Value") %>%
mutate(
Value = ifelse(Metric == "s.e.", paste0("(", round(Value, 2), ")"), round(Value, 2)), 
Metric = ifelse(Metric == "Mean", "Estimate", "SE") 
) %>%
  
pivot_wider(names_from = "Country", values_from = "Value") %>%
  
mutate("Variable" = ifelse(Metric == "SE", "", Variable)) 


data %>% 
  
select(-Metric, -Gender) %>% rename("Math Assessment"= Variable)%>% kable() %>%
  
  kable_classic_2(full_width = F, html_font = "Garamound") %>%
  
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))  %>%
  
  row_spec(0, bold = T) %>% pack_rows("Boys",1,6)%>%
  
 pack_rows("Girls",7,12)
```


```{r}
data<-data.frame(data) %>%  filter(Metric=='Estimate') %>% select(-Metric)
data_long <- data %>%
  pivot_longer(cols = starts_with("Finland"):starts_with("France"), 
               names_to = "Country", 
               values_to = "Estimate")
data_long$Estimate <- as.numeric(data_long$Estimate)


#Plot the data by gender, subject and country

ggplot(data_long, aes(x = Variable, y = Estimate, color = Gender, shape = Gender)) +
  geom_segment(aes(x = Variable, xend = Variable, y = 0, yend = Estimate)) +
  geom_point(size = 3, alpha = 0.7) +
  facet_wrap(~ Country) +
  theme_light() +
  coord_flip() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank()
  ) +
  labs(title = "PISA self - assessment by Subject, Gender, and Country", x = "Variable", y = "PV")+
  scale_color_manual(values = c("Boys" = "wheat4", "Girls" = "wheat2")) +theme(
    plot.title = element_text(size = 8),     
    plot.subtitle = element_text(size = 7),  
    plot.caption = element_text(size = 7),
     axis.title.x = element_text(size = 6),
     axis.title.y = element_text(size=6),
    legend.text = element_text(size = 6),
        legend.title = element_text(size = 7)) 
```

\newpage

### Complete Code

```{r ref.label=all_labels(), echo=T, eval=FALSE}

```

