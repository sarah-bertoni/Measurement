---
title: "Measurement IV"
autor: "Sarah Bertoni"
date:  20 November 2024
format:
  pdf: 
    fontsize: 9pt
    mainfont: Garamond
    sansfont: Garamond
editor: visual
output: 
  html_document:
    theme: cosmo
    latex_engine: pdflatex
    huxreg_options: "tabular={l|ccc}, tablewidth=0.1\\textwidth, tablefont=\\footnotesize"
    fig_caption: true
execute:
  echo: false
  warning: false
---

```{r}
### Libraries
library(sandwich)
library(lmtest)
library(magrittr)
library(zoo)
library(stringr)
library(haven)
library(tidyverse)
library(psych)
library(DT)
library(huxtable)
library(AER)
library(stargazer)
library(car)
library(modelsummary)
library(ggrepel)
library(kableExtra)
library(viridis)
library(gridExtra)
library(matrixStats)
library(Hmisc)
library(weights)
library(rmarkdown)
library(broom)
library(spatstat)
library(haven)
library(tidyverse)
library(knitr)
library(kableExtra)
library(tidyr)
library(Amelia)
library(sandwich)
library(lmtest)
library(miceadds)
library(huxtable)
library(matrixStats)
library(float) 
library(stargazer)
library(readxl)
library(gridExtra)
library(huxtable)
library(broom)
```

```{r}
civ <- read_dta("civ_87_08.dta")
```

## 1 Sampling and outliers

#### (a) In terms of sampling, what are the main limitations of survey data for measuring inequality?

Measuring inequality through sampling gives rise to many issues and limitations. The main challenge regards estimating income or consumption at the top and at the bottom of the distribution, as the tails of the distribution are more often subject to measurement errors or misreporting of income; additionally, very high and low incomes heavily influence inequality measures, which are particularly sensitive to outliers and can result in biased measures.

Moreover, it is difficult to capture all sources of incomes through surveys, as individuals may not declare part of it both intentionally or unintentionally.

Survey data lead to additional difficulties in terms of estimating a measure of inequality, namely:

-   Computing confidence intervals is particularly complicated when estimating indexes as complex functions of sampling data.
-   Using small samples easily leads to large biases as result of even small departures from normality, which translates in the need for a large number of observations.

#### (b) Why can it be important to exclude outliers for measuring inequality?

Large outliers -especially at the top of the distribution- strongly influence the results of inequality measuring; they may influence the shape of the distribution and skew it to the right, with it being otherwise normal, and consequently largely affect the related inference and estimation of inequality. It is important to mention how large outliers may easily be the result of measurement errors, such as misreported incomes or mis-written values or currency mismatch; high income are particularly subject to under reporting, as wealthy individuals may not want to disclose their real income. As a result, it is important to exclude outliers for the aim of measuring inequality so as to obtain a less biased estimation and avoid having results influenced by possible wrongly measured observations.

#### (c) Compute the level of consumption per capita per each household.

To calculate consumption per capita we divide the total household consumption by the number of people in the household; using adult equivalences may be more appropriate to account for the different level of consumption relative to different ages and needs.

```{r}
civ <- civ %>% mutate(cons_pc=constot/hhsize) #
```

The distribution of consumption per capita supports our argument for excluding outliers: we can observe by plotting the boxplots of consumption per capita for the years 1987, 1998 and 2008 that, while the average consumption per capita lies below the value of 1000 in each year, there is a large number of observations with very high values of consumption; removing these outliers will allow for a better measure of inequality,

```{r, fig.width=4, fig.height=4}

ggplot(civ, aes(y = cons_pc, x = factor(year))) + 
  geom_boxplot(aes(fill = factor(year)), alpha = 0.6) + 
  scale_fill_viridis(discrete = TRUE) + 
  theme_classic() +
  theme(
    legend.position = "none",
    plot.title = element_text(size = 11),
    plot.subtitle = element_text(size = 7),
    plot.caption = element_text(size = 7),
    axis.title.x = element_text(size = 7),
    axis.title.y = element_text(size = 7)
  ) +
  ggtitle("Consumption per capita boxplot by Year") +
  ylab("Consumption per capita") +
  labs(caption = "Notes: y limit set to 6000 to facilitate interpretation. Max cpc: 8488.415") +
  facet_wrap(~ year, scales = "free_x") + 
  scale_x_discrete(labels = c("1987", "1998", "2008")) +
  xlab('Year')+
  ylim(0,6000)

```

By plotting the distribution through an hisogram we can in fact observe a highly right skewed distribution, characteristic that can be explained by the large outliers with high consumption which translate in a heavy right tail.

```{r}
civ1987 <- civ %>% filter(year==1987) %>% mutate(log=log(cons_pc)) %>% mutate(medianpc=median(log)) %>% mutate(sdpc= sd(log)) %>% filter(log<(medianpc+3*sdpc)&log>(medianpc-3*sdpc))

civ1998 <- civ %>% filter(year==1998) %>% mutate(log=log(cons_pc)) %>% mutate(medianpc=median(log)) %>% mutate(sdpc= sd(log)) %>% filter(log<(medianpc+3*sdpc)&log>(medianpc-3*sdpc))
civ2008 <- civ %>% filter(year==2008) %>% mutate(log=log(cons_pc)) %>% mutate(medianpc=median(log)) %>% mutate(sdpc= sd(log)) %>% filter(log<(medianpc+3*sdpc)&log>(medianpc-3*sdpc))

plot_bf1<-ggplot(civ1987, aes(cons_pc)) +
  geom_histogram(aes(y = after_stat(density)), 
                 binwidth = 100, 
                 colour = "black", fill = "white", 
                 alpha = 0.5) +  
  geom_density(aes(y = ..density..), 
               alpha = 0.2, fill = "lightgreen") +
  theme_minimal() +
  labs(title = "1987 consumption per capita histogram",
       x = "consumption pc", y = "Density")+theme(
    plot.title = element_text(size = 8),     
    plot.subtitle = element_text(size = 7),  
    plot.caption = element_text(size = 7),
     axis.title.x = element_text(size = 6),
     axis.title.y = element_text(size=6)) + 
  geom_vline(xintercept = mean(civ1987$log, na.rm = TRUE), 
             color = "darkgreen", linetype = "dashed", size = 1)+
  xlim(0,5000)

plot_bf2<-ggplot(civ1998, aes(cons_pc)) +
  geom_histogram(aes(y = after_stat(density)), 
                 binwidth = 100, 
                 colour = "black", fill = "white", 
                 alpha = 0.5) +  
  geom_density(aes(y = ..density..), 
               alpha = 0.2, fill = "lightgreen") +
  theme_minimal() +
  labs(title = "1998 consumption per capita histogram",
       x = "consumption pc", y = "Density")+theme(
    plot.title = element_text(size = 8),     
    plot.subtitle = element_text(size = 7),  
    plot.caption = element_text(size = 7),
     axis.title.x = element_text(size = 6),
     axis.title.y = element_text(size=6)) + 
  geom_vline(xintercept = mean(civ1998$log, na.rm = TRUE), 
             color = "darkgreen", linetype = "dashed", size = 1)+
 xlim(0,5000)

plot_bf3<-ggplot(civ2008, aes(cons_pc)) +
  geom_histogram(aes(y = after_stat(density)), 
                 binwidth = 100, 
                 colour = "black", fill = "white", 
                 alpha = 0.5) +  
  geom_density(aes(y = ..density..), 
               alpha = 0.2, fill = "lightgreen") +
  theme_minimal() +
  labs(title = "2008 log consumption per capita histogram",
       x = "consumption pc", y = "Density")+theme(
    plot.title = element_text(size = 8),     
    plot.subtitle = element_text(size = 7),  
    plot.caption = element_text(size = 7),
     axis.title.x = element_text(size = 6),
     axis.title.y = element_text(size=6)) + 
  geom_vline(xintercept = mean(civ2008$log, na.rm = TRUE), 
             color = "darkgreen", linetype = "dashed", size = 1)+
 xlim(0,5000)

grid.arrange(plot_bf1, plot_bf2, plot_bf3, ncol = 1)
```

#### (d) It is proposed to computed the (non-weighted) median and standard deviation of the logarithm of consumption per capita for each year separately, and then to exclude those households whose logarithm consumption per capita is higher than the median by more than 3 standard deviations, or lower than the median by more than 3 standard deviations.

**-- Why is it suggested to take the logarithm? Why can ± 3 standard deviations be deemed rather safe?**

A logaritm transformation of the dependent variable allows for a better fitted normal distribution and renders the distribution less sensible to outliers. Excluding observations outside the three standard deviations threshold can be deemed safe since it is empirically observed that in a normal distribution nearly all observed data will fall within three standard deviations of the mean. More precisely, under such empirical rule, 68% of the data will fall within one standard deviation, 95% within two standard deviations, and 99.7% within three standard deviations from the mean. By including only data within ± 3 standard deviations we are consequentely excluding less than the 0.3% of the observations.

**-- Why should you use the unweighted median rather than the weighted median to identify outliers ?**

The unweighted median is more fitted to identify outliers since it is more robust than the weighted median to extreme valeus. A weighted median gives more importance to certain observation, which may result in outliers being ignored or non outliers being identified as such.

**-- Withdraw these observations from your database. This should not drop more than 157 observations in total.**

By plotting the distribution after correcting for outliers and transforming the dependent variable through a logaritmic specification we expect to observe a normal distribution of consumption across years. Correcting for outliers only results in dropping 121 observations.

```{r, fig.width=4, fig.height=4}


plot2<-ggplot(civ1987, aes(log)) +
  geom_histogram(aes(y = after_stat(density)), 
                 binwidth = 0.5, 
                 colour = "black", fill = "white", 
                 alpha = 0.5) +  
  geom_density(aes(y = ..density..), 
               alpha = 0.2, fill = "lightblue") +
  theme_minimal() +
  labs(title = "1987 log consumption per capita histogram",
       x = "consumption pc", y = "Density")+theme(
    plot.title = element_text(size = 8),     
    plot.subtitle = element_text(size = 7),  
    plot.caption = element_text(size = 7),
     axis.title.x = element_text(size = 6),
     axis.title.y = element_text(size=6)) + 
  geom_vline(xintercept = mean(civ1987$log, na.rm = TRUE), 
             color = "darkgreen", linetype = "dashed", size = 1)+
  xlim(2,10)

plot3<-ggplot(civ1998, aes(log)) +
  geom_histogram(aes(y = after_stat(density)), 
                 binwidth = 0.5, 
                 colour = "black", fill = "white", 
                 alpha = 0.5) +  
  geom_density(aes(y = ..density..), 
               alpha = 0.2, fill = "lightblue") +
  theme_minimal() +
  labs(title = "1998 log consumption per capita histogram",
       x = "consumption pc", y = "Density")+theme(
    plot.title = element_text(size = 8),     
    plot.subtitle = element_text(size = 7),  
    plot.caption = element_text(size = 7),
     axis.title.x = element_text(size = 6),
     axis.title.y = element_text(size=6)) + 
  geom_vline(xintercept = mean(civ1998$log, na.rm = TRUE), 
             color = "darkgreen", linetype = "dashed", size = 1)+
  xlim(2,10)

plot4<-ggplot(civ2008, aes(log)) +
  geom_histogram(aes(y = after_stat(density)), 
                 binwidth = 0.5, 
                 colour = "black", fill = "white", 
                 alpha = 0.5) +  
  geom_density(aes(y = ..density..), 
               alpha = 0.2, fill = "lightblue") +
  theme_minimal() +
  labs(title = "2008 log consumption per capita histogram",
       x = "consumption pc", y = "Density")+theme(
    plot.title = element_text(size = 8),     
    plot.subtitle = element_text(size = 7),  
    plot.caption = element_text(size = 7),
     axis.title.x = element_text(size = 6),
     axis.title.y = element_text(size=6)) + 
  geom_vline(xintercept = mean(civ2008$log, na.rm = TRUE), 
             color = "darkgreen", linetype = "dashed", size = 1)+
  xlim(2,10)


grid.arrange(plot2, plot3, plot4, ncol = 1)
```

As a matter of fact, the new distribution of consumption per capita follows a normal distribution, and is therefore more fitted to measure inequality.

```{r}
combined_civ <- bind_rows(civ1987, civ1998, civ2008)
#121 observation dropped. It is fine! 
```

\newpage

## 2 Consumer Price Index and Purchasing Power Parities

#### (a) Compute the budget shares of food and non-food consumption for the representative households in each region.

We create a dummy variable which identifies the representative households, defined as households with 4 members, male-headed and whose head is a blue-collar worker, either self-employed outside agriculture or a farmer. If a household meets all of these criteria we assign it a value of 1, and 0 otherwise.

```{r}
civ <- combined_civ %>% mutate(repr=(ifelse(hhsize==4 & femalehead==0 & (work_farmer==1|work_selfem==1),1,0)))
```

**Share of representative household**

We then compute the share of representative household through a regression, and observe a proportion of 6.5% of representative household among the population.

```{r}
rate<-(lm(data = civ, formula = repr ~ 1))




models_rates <- huxreg("Share of representative household" = rate,
                  error_format = "({std.error})",
                  error_pos = "below",
                  statistics = c(N = "nobs"),
                  note = "{stars}",
                  align = "center") %>%
  set_caption("Share of representative household in Ivory Coast")
set_latex_float(models_rates, value = "H")
```

In order to calculate the weighted average of the share of food and non food expenditure for the representative household we create a weight equal to the number of people in the household multiplied by the weight of the household multiplied by the consumption per capita of the household. The reasoning behind the use of such computed weight is mathematically shown:

```{r}
civ <- civ %>% mutate(food_share = exp_food/constot) %>% mutate(non_food_share = exp_othr/constot)
```

```{r}
civ <- civ %>%  mutate(weight1=hhsize*weight*cons_pc)
```

$\text{new weight}_i = \text{hh size}_i\cdot\text{weight}_i\cdot \text{consumption pc}_i$

Where the subscript $i$ indicates household level.

$\Longrightarrow \frac{\sum^n_{i=0}foodcons_i^{per capita} \cdot weight_i \cdot hhsize_i}{\sum^n_{i=0}totcons_i^{per capita} \cdot weight_i \cdot hhsize_i}$

$\text{share of food}= \frac{\sum_{i=0}^n foodcons_i \cdot weight_i}{\sum_{i=0}^n totcons_i \cdot weight_i}$

$\Longrightarrow \frac{\sum^n_{i=0}foodshare_i \cdot weight_i \cdot hhsize_i \cdot totcons^{per capita}_i}{\sum^n_{i=0}totcons_i^{per capita} \cdot weight_i \cdot hhsize_i}$

Which equals:

$\frac{\sum^n_{i=0} foodshare_i \cdot newweight_i }{\sum^n_{i=0}newweight_i}$

We can now compute budget shares using the new weight:

```{r}
foodnorth<-civ %>% filter(repr==1) %>% group_by(year)  %>% filter(north==1)%>%  summarise(average= round(weighted.mean(food_share,weight, na.rm = T),3)) 
foodsouth<-civ %>% filter(repr==1) %>% group_by(year)  %>% filter(north==0)%>%  summarise(average= round(weighted.mean(food_share,weight, na.rm = T),3))  


food_widen <- foodnorth %>%
  pivot_wider(names_from = year, values_from = average)%>% mutate(Region='North') %>%  
  select(Region, everything())  
food_wides <- foodsouth %>%
  pivot_wider(names_from = year, values_from = average)%>% mutate(Region='South') %>%  
  select(Region, everything())  

combined <- bind_rows(food_widen, food_wides) 


kable(combined,caption = 'Food Budget Shares in Cote d’Ivoire from 1987 to 2008.')%>%  
  kable_classic("hover", full_width = F, html_font = "Cambria") %>% kable_styling(bootstrap_options = c("striped", "hover"),  position = "center") %>%
  column_spec(1, bold = TRUE) %>%   
  row_spec(0, bold = TRUE) 



```

The weighted average of food expenditure reveals an higher share allocated to food in the northern region compared to the South. While there is no clear trend over time, food budget share decreased in 2008 compared to 1987 both in the north and in the south.

```{r}
#north
nonfoodnorth<-civ %>% filter(repr==1) %>% group_by(year)  %>% filter(north==1)%>%  summarise(average= round(weighted.mean(non_food_share,weight, na.rm = T),3)) 
#south
nonfoodsouth<-civ %>% filter(repr==1) %>% group_by(year)  %>% filter(north==0)%>%  summarise(average= round(weighted.mean(non_food_share,weight, na.rm = T),3))  

nonfood_widen <- nonfoodnorth %>%
  pivot_wider(names_from = year, values_from = average)%>% mutate(Region='North') %>%  
  select(Region, everything())  
nonfood_wides <- nonfoodsouth %>%
  pivot_wider(names_from = year, values_from = average)%>% mutate(Region='South') %>%  
  select(Region, everything())  

combined <- bind_rows(nonfood_widen, nonfood_wides) 


kable(combined,caption = 'Non Food Budget Shares in Cote d’Ivoire from 1987 to 2008.')%>%  
  kable_classic("hover", full_width = F, html_font = "Cambria") %>% kable_styling(bootstrap_options = c("striped", "hover"),  position = "center") %>%
  column_spec(1, bold = TRUE) %>%   
  row_spec(0, bold = TRUE) 

 

```

-   Conversely, we observe higher budget shares allocated to non food expenditure in the South compared to the North.

    Such results can be explained by the predominance of cities and fertile areas in the south, which make such regions more developed and inhabited by richer individuals. As a matter of fact, poverty is much higher in rural regions and far higher in the north of the country, which exhibits a weaker economy and weaker institutions. This gegraphical context aligns with Engel's law, which states that individuals with higher incomes tend to spend a smaller share of their income on food. Once again, there is no clear time trend, but we do observe a net increase in non food budget share from 1987 to 2008 in both regions.

#### (b) CPI

**b.1) Laspeyres CPI**

The Laspeyres index gives the cost of purchasing a given base consumption basket at current price relative to buying the same base basket of goods at the price of a base year, which in our case corresponds to 1987. It is regarded as an upper bound of the base-weighted Cost Of Living Index as it assumes no substitution effect and therefore tends to overestimate costs of living.

$\text{Laspeyres CPI}\_{\text{region}} = \frac{\text{avprice food}_t \times {quantity food}_0}{\text{avprice food}_0 \times {quantity food}_0} + \frac{\text{avprice other}_t\times \text{quantity other}_0}{\text{avprice other}_0\times \text{quantity other}_0}$

It can be computed using budget shares with the following formula:

$\text{Laspeyres CPI}_{\text{region}} = \text{bdgshr food}_0\times\frac{\text{avprice food}_t }{\text{avprice food}_0} + \frac{\text{avprice other}_t}{\text{avprice other}_0} \times \text{bdgshr other}_0$

```{r}
civ1987_NORTH<-civ1987%>% filter(north==1) 
civ1987_NORTH<- civ1987_NORTH%>% mutate(LCPI=(mean(civ1987_NORTH$bdgshr_food)*avprice_food+mean(civ1987_NORTH$bdgshr_othr)*avprice_othr))
civ1998_NORTH<-civ1998%>% filter(north==1) %>% mutate(LCPI=(mean(civ1987_NORTH$bdgshr_food)*avprice_food+mean(civ1987_NORTH$bdgshr_othr)*avprice_othr))
civ2008_NORTH<-civ2008%>% filter(north==1) %>% mutate(LCPI=(mean(civ1987_NORTH$bdgshr_food)*avprice_food+mean(civ1987_NORTH$bdgshr_othr)*avprice_othr))


combined_civ_NORTH <- bind_rows(civ1987_NORTH, civ1998_NORTH, civ2008_NORTH)

north_civ<-combined_civ_NORTH %>% mutate(LPCI_index=LCPI*100/(mean(civ1987_NORTH$bdgshr_food)*mean(civ1987_NORTH$avprice_food)+(mean(civ1987_NORTH$bdgshr_othr)*mean(civ1987_NORTH$avprice_othr))))

north_lasp<-north_civ  %>%  group_by(year) %>% summarise(CPI=round(mean(LPCI_index),2))
result_wide_north_lasp <- north_lasp %>%
  pivot_wider(names_from = year, values_from = CPI)%>% mutate(Region='North') %>%  
  select(Region, everything())  


```

```{r}
civ1987_SOUTH<-civ1987%>% filter(north==0) 
civ1987_SOUTH<-civ1987_SOUTH%>% mutate(LCPI=(civ1987_SOUTH$bdgshr_food*avprice_food+mean(civ1987_SOUTH$bdgshr_othr)*avprice_othr))
civ1998_SOUTH<-civ1998%>% filter(north==0) %>% mutate(LCPI=civ1987_SOUTH$bdgshr_food*avprice_food+mean(civ1987_SOUTH$bdgshr_othr)*avprice_othr)
civ2008_SOUTH<-civ2008%>% filter(north==0) %>% mutate(LCPI=mean(civ1987_SOUTH$bdgshr_food)*avprice_food+mean(civ1987_SOUTH$bdgshr_othr)*avprice_othr)


combined_civ_SOUTH <- bind_rows(civ1987_SOUTH, civ1998_SOUTH, civ2008_SOUTH)


SOUTH_civ<-combined_civ_SOUTH %>% mutate(L_CPI=LCPI*100/(mean(civ1987_SOUTH$bdgshr_food)*mean(civ1987_SOUTH$avprice_food)+(mean(civ1987_SOUTH$bdgshr_othr)*mean(civ1987_SOUTH$avprice_othr))))
south_lasp<- SOUTH_civ  %>%  group_by(year) %>% summarise(CPI=round(mean(L_CPI),3)) 
result_wide_south_lasp <- south_lasp %>%
  pivot_wider(names_from = year, values_from = CPI) %>% mutate(Region='South') %>%  
  select(Region, everything())  


combined_df <- bind_rows(result_wide_north_lasp, result_wide_south_lasp) 
kable(combined_df,caption = 'Laspeyres CPI in Cote d’Ivoire from 1987 to 2008')%>%  
  kable_classic("hover", full_width = F, html_font = "Cambria") %>% kable_styling(bootstrap_options = c("striped", "hover"),  position = "center") %>%
  column_spec(1, bold = TRUE) %>%   
  row_spec(0, bold = TRUE) 

```

We observe higher cost of living in the South compared to the North at any period in time, in line with our previous observations. By merely comparing the same region over time, however, we can conclude that both south and north experienced a similar increase in the cost of living (from 1998 to 2008 the Laspeyres CPI increased approximately by 33% in both cases).

**b.2) the Paasche CPI**

The Paasche price index is current-weighted and represents a lower bound for the current weighted COLI (since it assumes substitution towards cheaper goods). It compares the current period basket of good at base price and current price, therefore measuring how the price of the current basket of good has changed over time.

$\text{Paasche CPI}_{\text{region}} = \text{bdgshr food}_t\times\frac{\text{avprice food}_t }{\text{avprice food}_0} + \frac{\text{avprice other}_t}{\text{avprice other}_0} \times \text{bdgshr other}_t$

```{r}
civ1987_SOUTH<-civ1987%>% filter(north==0) %>% mutate(LCPI=bdgshr_food*avprice_food+bdgshr_othr*avprice_othr)
civ1998_SOUTH<-civ1998%>% filter(north==0) %>%mutate(LCPI=bdgshr_food*avprice_food+bdgshr_othr*avprice_othr)
civ2008_SOUTH<-civ2008%>% filter(north==0) %>% mutate(LCPI=bdgshr_food*avprice_food+bdgshr_othr*avprice_othr)
combined_civ_SOUTH <- bind_rows(civ1987_SOUTH, civ1998_SOUTH, civ2008_SOUTH)

SOUTH_civ<-combined_civ_SOUTH %>% mutate(PCPI=LCPI*100/(bdgshr_food*mean(civ1987_SOUTH$avprice_food)+bdgshr_othr*mean(civ1987_SOUTH$avprice_othr)))



south_pas<- SOUTH_civ  %>%  group_by(year) %>% summarise(CPI=round(mean(PCPI),3)) 
result_wide_south_pas <- south_pas %>%
  pivot_wider(names_from = year, values_from = CPI) %>% mutate(Region='South') %>%  
  select(Region, everything())  


```

```{r}

civ1987_NORTH <- civ1987 %>% filter(north == 1) %>% mutate(LCPI = bdgshr_food * avprice_food + bdgshr_othr * avprice_othr)
civ1998_NORTH <- civ1998 %>% filter(north == 1) %>% mutate(LCPI = bdgshr_food * avprice_food + bdgshr_othr * avprice_othr)
civ2008_NORTH <- civ2008 %>% filter(north == 1) %>% mutate(LCPI = bdgshr_food * avprice_food + bdgshr_othr * avprice_othr)
combined_civ_NORTH <- bind_rows(civ1987_NORTH, civ1998_NORTH, civ2008_NORTH)

NORTH_civ <- combined_civ_NORTH %>% mutate(PCPI = LCPI * 100 / (bdgshr_food * mean(civ1987_NORTH$avprice_food) + bdgshr_othr * mean(civ1987_NORTH$avprice_othr)))


north_pas<-NORTH_civ  %>%  group_by(year) %>% summarise(CPI=round(mean(PCPI),3))
result_wide_north_pas <- north_pas %>%
  pivot_wider(names_from = year, values_from = CPI)%>% mutate(Region='North') %>%  
  select(Region, everything())  


combined_df <- bind_rows(result_wide_north_pas, result_wide_south_pas) 
kable(combined_df,caption = 'Paasche CPI in Cote d’Ivoire from 1987 to 2008')%>%  
  kable_classic("hover", full_width = F, html_font = "Cambria") %>% kable_styling(bootstrap_options = c("striped", "hover"),  position = "center") %>%
  column_spec(1, bold = TRUE) %>%   
  row_spec(0, bold = TRUE)  


```

We observe very similar results for the two indexes, with cost of living increasing over time and being higher in the South. The Paasche index is usually lower than the Laspeyres CPI; however, in our case there is no such clear difference

#### (c) Compute a PPP aggregate for the North region with respect to the South. For each year in your dataset, compute:

**c.1) the Laspeyres PPP of Northern Cote d'Ivoire.**

The Laspeyres PPP of Northern Cote d'Ivoire with respect to the South is the the geometric mean of the price relatives for products representative of the south, meaning that it can be computed as the ratio of the prices in the North and in the South weighted by the quantity consumed in the south.

$\text{LPPP} = \left( \text{bdgshr food}_{\text{SOUTH}} \times \frac{\text{avprice food}_{\text{NORTH}}}{\text{avprice food}_{\text{SOUTH}}} \right) + \left( \text{bdgshrothr}_{\text{SOUTH}} \times \frac{\text{avprice othr}_{\text{NORTH}}}{\text{avprice othr}_{\text{SOUTH}}} \right)$

```{r}
# For 1987, 1998, and 2008, compute Laspeyres PPP for Northern Côte d'Ivoire

# Laspeyres PPP for 1987
civ1987_NORTH <- civ1987_NORTH %>%
  mutate(LPPP = (civ1987_SOUTH$bdgshr_food[1] * (avprice_food[1]/civ1987_SOUTH$avprice_food[1]) + civ1987_SOUTH$bdgshr_othr[1] * (avprice_othr[1] / civ1987_SOUTH$avprice_othr[1])))


# Laspeyres PPP for 1998
civ1998_NORTH <- civ1998_NORTH %>%
  mutate(LPPP = (civ1998_SOUTH$bdgshr_food[1] * (avprice_food[1]/civ1998_SOUTH$avprice_food[1]) + civ1998_SOUTH$bdgshr_othr[1] * (avprice_othr[1] / civ1998_SOUTH$avprice_othr[1])))

# Laspeyres PPP for 2008
civ2008_NORTH <- civ2008_NORTH %>%
  mutate(LPPP = (civ2008_SOUTH$bdgshr_food[1] * (avprice_food[1]/civ2008_SOUTH$avprice_food[1]) + civ2008_SOUTH$bdgshr_othr[1] * (avprice_othr[1] / civ2008_SOUTH$avprice_othr[1])))

# Combine data for all years
combined_civ_NORTH <- bind_rows(civ1987_NORTH, civ1998_NORTH, civ2008_NORTH)

# Calculate the average Laspeyres PPP for each year
Laspeyres_PPP<- combined_civ_NORTH %>%
  group_by(year) %>%
  summarise(LPPP_avg = mean(LPPP, na.rm = TRUE)) %>%
  kable(caption = 'Laspeyres PPP in the North') %>%  
  kable_paper("hover", full_width = F, html_font = "Cambria") %>% kable_styling(bootstrap_options = c("striped", "hover"),  position = "float_left")


```

```{r}
# For the south region in 1987, 1998, and 2008
# Laspeyres PPP for 1987
civ1987_SOUTH <- civ1987_SOUTH %>%
  mutate(LPPP = (civ1987_SOUTH$bdgshr_food[1] * (avprice_food[1]/civ1987_SOUTH$avprice_food[1]) + civ1987_SOUTH$bdgshr_othr[1] * (avprice_othr[1] / civ1987_SOUTH$avprice_othr[1])))


# Laspeyres PPP for 1998
civ1998_SOUTH <- civ1998_SOUTH %>%
  mutate(LPPP = (civ1998_SOUTH$bdgshr_food[1] * (avprice_food[1]/civ1998_SOUTH$avprice_food[1]) + civ1998_SOUTH$bdgshr_othr[1] * (avprice_othr[1] / civ1998_SOUTH$avprice_othr[1])))

# Laspeyres PPP for 2008
civ2008_SOUTH <- civ2008_SOUTH %>%
  mutate(LPPP = (civ2008_SOUTH$bdgshr_food[1] * (avprice_food[1]/civ2008_SOUTH$avprice_food[1]) + civ2008_SOUTH$bdgshr_othr[1] * (avprice_othr[1] / civ2008_SOUTH$avprice_othr[1])))

# Combine data for all years
combined_civ_SOUTH <- bind_rows(civ1987_SOUTH, civ1998_SOUTH, civ2008_SOUTH)

# Calculate the average Laspeyres PPP for each year
Laspeyres_PPP<- combined_civ_SOUTH %>%
  group_by(year) %>%
  summarise(LPPP_avg = mean(LPPP, na.rm = TRUE)) %>%
  kable(caption = 'Laspeyres PPP in the North') %>%  
  kable_paper("hover", full_width = F, html_font = "Cambria") %>% kable_styling(bootstrap_options = c("striped", "hover"),  position = "float_left")

north_las<-combined_civ_NORTH  %>%  group_by(year) %>% summarise(LPPP=round(mean(LPPP),3))
result_wide_north_las <- north_las %>%
  pivot_wider(names_from = year, values_from = LPPP)%>% mutate(Region='North') %>%  
  select(Region, everything())  

south_las<-combined_civ_SOUTH  %>%  group_by(year) %>% summarise(LPPP=round(mean(LPPP),3))
result_wide_south_las <- south_las %>%
  pivot_wider(names_from = year, values_from = LPPP)%>% mutate(Region='South') %>%  
  select(Region, everything())


combined_df <- bind_rows(result_wide_north_las, result_wide_south_las) 
kable(combined_df,caption = 'Laspeyres PPP in Cote d’Ivoire from 1987 to 2008')%>%  
  kable_paper("hover", full_width = F, html_font = "Cambria")%>% kable_styling(bootstrap_options = c("striped", "hover"),  position = "center") %>%
  column_spec(1, bold = TRUE) %>%   
  row_spec(0, bold = TRUE)  
```

The PPP index for the North decreases over time: what you could buy with 100 CFA franc in the South in 1987 was worth 73 CFA francs in the North, while it was worth 69 and 66 CFA francs in 1998 and 2008, respectively. This implies that cost of living have increased more in the South with respect to the North.

**c.2) The Paasche PPP of Northern Cote d'Ivoire.**

The Paasche PPP is computed similarly to the Laspeyers, nontheless using the quantity consumed in the North as a reference weight.

$\text{PPPP} = \left( \text{bdgshr food}_{\text{NORTH}} \times \frac{\text{avprice food}_{\text{NORTH}}}{\text{avprice food}_{\text{SOUTH}}} \right) + \left( \text{bdgshr othr}_{\text{NORTH}} \times \frac{\text{avprice othr}_{\text{NORTH}}}{\text{avprice othr}_{\text{SOUTH}}} \right)$

```{r}

# Paasche PPP for 1987

civ1987_NORTH <- civ1987_NORTH %>%
  mutate(PPPP = (bdgshr_food[1] * (avprice_food[1]/civ1987_SOUTH$avprice_food[1]) + bdgshr_othr[1] * (avprice_othr[1] / civ1987_SOUTH$avprice_othr[1])))


# Paasche PPP for 1998
civ1998_NORTH <- civ1998_NORTH %>%
  mutate(PPPP = (bdgshr_food[1] * (avprice_food[1]/civ1998_SOUTH$avprice_food[1]) + bdgshr_othr[1] * (avprice_othr[1] / civ1998_SOUTH$avprice_othr[1])))

# Paasche PPP for 2008
civ2008_NORTH <- civ2008_NORTH %>%
  mutate(PPPP = (bdgshr_food[1] * (avprice_food[1]/civ2008_SOUTH$avprice_food[1]) + bdgshr_othr[1] * (avprice_othr[1] / civ2008_SOUTH$avprice_othr[1])))

# Combine data for all years
combined_civ_NORTH <- bind_rows(civ1987_NORTH, civ1998_NORTH, civ2008_NORTH)


```

```{r}
# For 1987, 1998, and 2008, compute Paasche PPP for Southern Cote d'Ivoire
civ1987_SOUTH <- civ1987_SOUTH %>%
  mutate(PPPP = (bdgshr_food[1] * (avprice_food[1]/civ1987_SOUTH$avprice_food[1]) + bdgshr_othr[1] * (avprice_othr[1] / civ1987_SOUTH$avprice_othr[1])))


# Paasche PPP for 1998
civ1998_SOUTH <- civ1998_SOUTH %>%
  mutate(PPPP = (bdgshr_food[1] * (avprice_food[1]/civ1998_SOUTH$avprice_food[1]) + bdgshr_othr[1] * (avprice_othr[1] / civ1998_SOUTH$avprice_othr[1])))

# Paasche PPP for 2008
civ2008_SOUTH <- civ2008_SOUTH %>%
  mutate(PPPP = (bdgshr_food[1] * (avprice_food[1]/civ2008_SOUTH$avprice_food[1]) + bdgshr_othr[1] * (avprice_othr[1] / civ2008_SOUTH$avprice_othr[1])))

# Combine data for all years
combined_civ_SOUTH <- bind_rows(civ1987_SOUTH, civ1998_SOUTH, civ2008_SOUTH)



north_las<-combined_civ_NORTH  %>%  group_by(year) %>% summarise(PPPP=round(mean(PPPP),3))
result_wide_north_las <- north_las %>%
  pivot_wider(names_from = year, values_from = PPPP)%>% mutate(Region='North') %>%  
  select(Region, everything())  

south_las<-combined_civ_SOUTH  %>%  group_by(year) %>% summarise(PPPP=round(mean(PPPP),3))
result_wide_south_las <- south_las %>%
  pivot_wider(names_from = year, values_from = PPPP)%>% mutate(Region='South') %>%  
  select(Region, everything())


combined_df <- bind_rows(result_wide_north_las, result_wide_south_las) 
kable(combined_df,caption = 'Paasche  PPP in Cote d’Ivoire from 1987 to 2008')%>%  
  kable_classic("hover", full_width = F, html_font = "Cambria") %>% kable_styling(bootstrap_options = c("striped", "hover"),  position = "center") %>%
  column_spec(1, bold = TRUE) %>%   
  row_spec(0, bold = TRUE)  


```

The Paasche PPP produces similar if slightly higher results, it being an upper bound, as we previously explained.

**c.3) The Fisher PPP**

$FPPP= \sqrt{LPPP \times PPPP}$

The Fisher PPP is the geometric mean of the Laspeyres and Paasche PPP and we therefore expect values in between the two indexes.

```{r}
# For 1987, 1998, and 2008, compute Fisher PPP for Northern Cote d'Ivoire

# Fisher PPP for 1987
civ1987_NORTH <- civ1987_NORTH %>%
  mutate(Fisher_PPP = round(sqrt(LPPP * PPPP),3))

# Fisher PPP for 1998
civ1998_NORTH <- civ1998_NORTH %>%
  mutate(Fisher_PPP = round(sqrt(LPPP * PPPP),3))

# Fisher PPP for 2008
civ2008_NORTH <- civ2008_NORTH %>%
  mutate(Fisher_PPP = round(sqrt(LPPP * PPPP),3))

# Combine data for all years
combined_civ_NORTH <- bind_rows(civ1987_NORTH, civ1998_NORTH, civ2008_NORTH)


```

```{r}
# For 1987, 1998, and 2008, compute Fisher PPP for Southern Cote d'Ivoire

# Fisher PPP for 1987 in the South
civ1987_SOUTH <- civ1987_SOUTH %>%
  mutate(Fisher_PPP = round(sqrt(LPPP * PPPP),3))

# Fisher PPP for 1998 in the South
civ1998_SOUTH <- civ1998_SOUTH %>%
  mutate(Fisher_PPP = round(sqrt(LPPP * PPPP),3))
# Fisher PPP for 2008 in the South
civ2008_SOUTH <- civ2008_SOUTH %>%
  mutate(Fisher_PPP = round(sqrt(LPPP * PPPP),3))

# Combine data for all years in the South
combined_civ_SOUTH <- bind_rows(civ1987_SOUTH, civ1998_SOUTH, civ2008_SOUTH)

north_las<-combined_civ_NORTH  %>%  group_by(year) %>% summarise(Fisher_PPP=mean(Fisher_PPP))
result_wide_north_las <- north_las %>%
  pivot_wider(names_from = year, values_from = Fisher_PPP)%>% mutate(Region='North') %>%  
  select(Region, everything())  

south_las<-combined_civ_SOUTH  %>%  group_by(year) %>% summarise(Fisher_PPP=mean(Fisher_PPP))
result_wide_south_las <- south_las %>%
  pivot_wider(names_from = year, values_from = Fisher_PPP)%>% mutate(Region='South') %>%  
  select(Region, everything())


combined_df <- bind_rows(result_wide_north_las, result_wide_south_las) 
kable(combined_df,caption = 'Fisher  PPP in Cote d’Ivoire from 1987 to 2008')%>%  
  kable_classic("hover", full_width = F, html_font = "Cambria") %>% kable_styling(bootstrap_options = c("striped", "hover"),  position = "center") %>%
  column_spec(1, bold = TRUE) %>%   
  row_spec(0, bold = TRUE)  


```

The three PPP indexes highlight the same trend: prices in the North are decreasing in comparison to prices in the South.

#### (d) Use the Laspeyres CPI and PPP available in Table 3 and convert the values of the consumption variable for all years and regions into comparable values, taking as a reference the South of Cote d'Ivoire in 1987.

*Table 9* shows average consumption per capita weighted by the individual weights previously computed adjusted for inflation -using 1987 as a reference year- and for purchase power parity -using South as a base region. To obtain such variable we divide consumption per capita by the Laspeyres PPP and CPI.

$$
cons87= conspc\cdot\frac{1}{PPP\times CPI}
$$

```{r}
civ <- civ %>% mutate(cons_87=ifelse(north==1, conspc/(ppp/100),conspc))

```

```{r}
civ <- civ %>% mutate(conspc87=cons_87/(cpi/100))%>% mutate(weight2=weight*hhsize)


# Calculate weighted mean by region and year
grouped_data <- civ %>%
  mutate(Regions = ifelse(north == 1, 'North', 'South')) %>%
  group_by(Regions, year) %>%
  summarise('consumption ppp' = round(weighted.mean(conspc87, weight2), 3), .groups = 'drop') %>%
  pivot_wider(names_from = year, values_from = 'consumption ppp')

# Calculate the total weighted mean (not grouped by region)
total_data <- civ %>% group_by(year) %>% 
  summarise('consumption ppp' = round(weighted.mean(conspc87, weight2), 3)) %>%
  mutate(Regions = 'National') %>%
  pivot_wider(names_from = year, values_from = 'consumption ppp')

# Combine both grouped data and the total weighted mean
final_data <- bind_rows(grouped_data, total_data)

# Create the table with kable
final_data %>%
  kable(col.names = c('Region', '1987', '1998', '2008'), caption = 'Consumption per capita in Cote d’Ivoire from 1987 to 2008 - PPP') %>%
  kable_classic("hover", full_width = F, html_font = "Cambria") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), position = "center") %>%
  column_spec(1, bold = TRUE) %>%   
  row_spec(0, bold = TRUE) 


```

*Table 10* shows average consumption per capita weighted by individual weights before the adjustment.

```{r}
grouped_data <- civ %>%
  mutate(Regions = ifelse(north == 1, 'North', 'South')) %>%
  group_by(Regions, year) %>%
  summarise('consumption' = round(weighted.mean(conspc, weight2), 3), .groups = 'drop') %>%
  pivot_wider(names_from = year, values_from = 'consumption')

# Calculate the total weighted mean (not grouped by region)
total_data <- civ %>% group_by(year) %>% 
  summarise('consumption' = round(weighted.mean(conspc, weight2), 3)) %>%
  mutate(Regions = 'National') %>%
  pivot_wider(names_from = year, values_from = 'consumption')

# Combine both grouped data and the total weighted mean
final_data <- bind_rows(grouped_data, total_data)

# Create the table with kable
final_data %>%
  kable(col.names = c('Region', '1987', '1998', '2008'), caption = 'Consumption per capita in Cote d’Ivoire from 1987 to 2008 - before adjustment') %>%
  kable_classic("hover", full_width = F, html_font = "Cambria") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), position = "center") %>%
  column_spec(1, bold = TRUE) %>%   
  row_spec(0, bold = TRUE)


```

Nominal average consumption per capita increases over time both at the regional and national level, with consumption in the South being higher than consumption in the North at every period in time. However, once we adjust for PPP and inflation, consumption shows a decreasing trend over time at every regional and national level; moreover, adjusted consumption is higher in the North compared to the South at every period in time.

\newpage

## 3. Poverty Rate headcount

#### (a) The poverty threshold of one dollar a day is equivalent to 237 franc CFA 1987.

In order to compute the poverty rate we create a dummy which indicates that an household is poor if their adjusted consumption per capita is below the one dollar threshold, equivalent to 237 franc CFA. We use individual household weights to calculate the yearly poverty rate at the regional and national level.

```{r}
civ <- civ %>% 
  mutate(pov_dummy = ifelse(conspc87 < 237, 1, 0)
         )

# Computing poverty rates
lm_N_87_4 <- lm(pov_dummy ~ 1, weights = weight2, 
              data = subset(civ, year == 1987 & north == 1))
lm_S_87_4 <- lm(pov_dummy ~ 1, weights = weight2, 
              data = subset(civ, year == 1987 & north == 0))
lm_Nat_87_4 <- lm(pov_dummy ~ 1, weights = weight2, 
              data = subset(civ, year == 1987))
lm_N_98_4 <- lm(pov_dummy ~ 1, weights = weight2, 
              data = subset(civ, year == 1998 & north == 1))
lm_S_98_4 <- lm(pov_dummy ~ 1, weights = weight2, 
              data = subset(civ, year == 1998 & north == 0))
lm_Nat_98_4 <- lm(pov_dummy ~ 1, weights = weight2, 
              data = subset(civ, year == 1998))
lm_N_08_4 <- lm(pov_dummy ~ 1, weights = weight2, 
              data = subset(civ, year == 2008 & north == 1))
lm_S_08_4 <- lm(pov_dummy ~ 1, weights = weight2, 
              data = subset(civ, year == 2008 & north == 0))
lm_Nat_08_4 <- lm(pov_dummy ~ 1, weights = weight2, 
              data = subset(civ, year == 2008))

# Building the table
table_north <- huxreg("1987" = lm_N_87_4, "1998" = lm_N_98_4, "2008" = lm_N_08_4,
       statistics = c(N = "nobs"), coefs = c("North:" = "(Intercept)"), note = NULL)
table_south <- huxreg("1987" = lm_S_87_4, "1998" = lm_S_98_4, "2008" = lm_S_08_4,
       statistics = c(N = "nobs"), coefs = c("South:" = "(Intercept)"), note = NULL)
table_Nat <- huxreg("1987" = lm_Nat_87_4, "1998" = lm_Nat_98_4, "2008" = lm_Nat_08_4,
       statistics = c(N = "nobs"), coefs = c("National Level:" = "(Intercept)"), note = NULL)


table_4 <- rbind(table_north[1:3,], table_south[2:3,], table_Nat[2:4,])
caption(table_4) <- c("Poverty Rates With 1 dollar Threshold - Cote d’Ivoire from 1987 to 2008")
set_latex_float(table_4, value = "H")


```

Poverty rates increased over time at every regional level and at the national level, with the South experiencing an higher overall increase; however, poverty rates in the North and in the South are not statistically different in 2008, while they are in the previous years.

#### (b) Now, the poverty threshold is set to two dollars a day, or 474 franc CFA in 1987.

```{r}
# Creating the new variables
data <- civ %>% 
  mutate(new_pov_dummy = ifelse(conspc87 < 474, 1, 0))

# Computing poverty rates
lm_N_87_5 <- lm(new_pov_dummy ~ 1, weights = weight2, 
              data = subset(data, year == 1987 & north == 1))
lm_S_87_5 <- lm(new_pov_dummy ~ 1, weights = weight2, 
              data = subset(data, year == 1987 & north == 0))
lm_Nat_87_5 <- lm(new_pov_dummy ~ 1, weights = weight2, 
              data = subset(data, year == 1987))
lm_N_98_5 <- lm(new_pov_dummy ~ 1, weights = weight2, 
              data = subset(data, year == 1998 & north == 1))
lm_S_98_5 <- lm(new_pov_dummy ~ 1, weights = weight2, 
              data = subset(data, year == 1998 & north == 0))
lm_Nat_98_5 <- lm(new_pov_dummy ~ 1, weights = weight2, 
              data = subset(data, year == 1998))
lm_N_08_5 <- lm(new_pov_dummy ~ 1, weights = weight2, 
              data = subset(data, year == 2008 & north == 1))
lm_S_08_5 <- lm(new_pov_dummy ~ 1, weights = weight2, 
              data = subset(data, year == 2008 & north == 0))
lm_Nat_08_5 <- lm(new_pov_dummy ~ 1, weights = weight2, 
              data = subset(data, year == 2008))

# Building the table
table_north <- huxreg("1987" = lm_N_87_5, "1998" = lm_N_98_5, "2008" = lm_N_08_5,
       statistics = c(N = "nobs"), coefs = c("North:" = "(Intercept)"), note = NULL)
table_south <- huxreg("1987" = lm_S_87_5, "1998" = lm_S_98_5, "2008" = lm_S_08_5,
       statistics = c(N = "nobs"), coefs = c("South:" = "(Intercept)"), note = NULL)
table_Nat <- huxreg("1987" = lm_Nat_87_5, "1998" = lm_Nat_98_5, "2008" = lm_Nat_08_5,
       statistics = c(N = "nobs"), coefs = c("National Level:" = "(Intercept)"), note = NULL)


table_5 <- rbind(table_north[1:3,], table_south[2:3,], table_Nat[2:4,])
caption(table_5) <- c("Poverty Rates With 2 dollar Threshold - Cote d’Ivoire from 1987 to 2008")
set_latex_float(table_5, value = "H")
 
```

Poverty rates computed using a 2 dollar threshold are statistically higher then the one at the one dollar threshold. The Northern poverty rates experience a larger increase in value than the South: the Norther region exhibits a trend of a larger proportion of people experiencing less extreme poverty compared to the South. Once again, we observe an increase in poverty over time, result in line with the economic crisis experienced by Cote d'Ivoire starting in 1998. Poverty rates in the North and in the South in 1998 and 2008 are not statistically different from each other.

#### (c) Assume that price levels and preferences do not differ across regions. This means that the CPI observed in the South is also valid in the North. Likewise, the PPP factor is 1 across regions.

Assuming the same CPI for both regions we observe statistically higher poverty rates in the North, both compared to the South and to the previous measures in the North. Such result is in line with our previous finding: one franc is worth less in the North than in the South, meaning that by not accounting for such difference we find more people suffering from extreme poverty in the North. At the national level poverty rates are significantly higher, if not by a large amount.

```{r}
# Creating the new variables
data <- data %>% 
  mutate(new_cpi = case_when( 
    year == 1987 ~ 100,          
    year == 1998 ~ 192.45,       
    year == 2008 ~ 255.73
  ),
  newconspc_87 = conspc * (100/new_cpi),
  pov_dummy_2 = ifelse(newconspc_87 < 237, 1, 0))

# Calculating poverty rates
lm_N_87_6 <- lm(pov_dummy_2 ~ 1, weights = weight2, 
              data = subset(data, year == 1987 & north == 1))
lm_S_87_6 <- lm(pov_dummy_2 ~ 1, weights = weight2, 
              data = subset(data, year == 1987 & north == 0))
lm_Nat_87_6 <- lm(pov_dummy_2 ~ 1, weights = weight2, 
              data = subset(data, year == 1987))
lm_N_98_6 <- lm(pov_dummy_2 ~ 1, weights = weight2, 
              data = subset(data, year == 1998 & north == 1))
lm_S_98_6 <- lm(pov_dummy_2 ~ 1, weights = weight2, 
              data = subset(data, year == 1998 & north == 0))
lm_Nat_98_6 <- lm(pov_dummy_2 ~ 1, weights = weight2, 
              data = subset(data, year == 1998))
lm_N_08_6 <- lm(pov_dummy_2 ~ 1, weights = weight2, 
              data = subset(data, year == 2008 & north == 1))
lm_S_08_6 <- lm(pov_dummy_2 ~ 1, weights = weight2, 
              data = subset(data, year == 2008 & north == 0))
lm_Nat_08_6 <- lm(pov_dummy_2 ~ 1, weights = weight2, 
              data = subset(data, year == 2008))

# Building the table
table_north <- huxreg("1987" = lm_N_87_6, "1998" = lm_N_98_6, "2008" = lm_N_08_6,
       statistics = c(N = "nobs"), coefs = c("North:" = "(Intercept)"), note = NULL)
table_south <- huxreg("1987" = lm_S_87_6, "1998" = lm_S_98_6, "2008" = lm_S_08_6,
       statistics = c(N = "nobs"), coefs = c("South:" = "(Intercept)"), note = NULL)
table_Nat <- huxreg("1987" = lm_Nat_87_6, "1998" = lm_Nat_98_6, "2008" = lm_Nat_08_6,
       statistics = c(N = "nobs"), coefs = c("National Level:" = "(Intercept)"), note = NULL)


table_6 <- rbind(table_north[1:3,], table_south[2:3,], table_Nat[2:4,])
caption(table_6) <- c("New Poverty Rates Across Regions and Time - Cote d’Ivoire from 1987 to 2008")
table_6
```

\newpage

## 4. Growth incidence curves

For each year we associate to each percentile its corresponding per capita consumption using individual weights (household weight multiplied by household size) and we compute the average growth for each percentile over the two 11 years long periods.

```{r, fig.width=4, fig.height=3}
civ <- civ %>%
  mutate(conspc_87 = ifelse(year == "1987", conspc87, NA_real_),
         conspc_98 = ifelse(year == "1998", conspc87, NA_real_),
         conspc_08 = ifelse(year == "2008", conspc87, NA_real_)
         )

percentiles <- seq(0, 1, by = 0.01)

ewcdf_87 <- ewcdf(civ$conspc_87, weights = civ$weight2)
ewcdf_98 <- ewcdf(civ$conspc_98, weights = civ$weight2)
ewcdf_08 <- ewcdf(civ$conspc_08, weights = civ$weight2)
consperc_87 <- quantile(ewcdf_87, percentiles, na.rm = TRUE)
consperc_98 <- quantile(ewcdf_98, percentiles, na.rm = TRUE)
consperc_08 <- quantile(ewcdf_08, percentiles, na.rm = TRUE)

#b  growth rates 
# 11 years between 1987 and 1998
growth98 <- ((consperc_98/consperc_87))^(1/11) -1
# 10 years between 1998 and 2008
growth08 <- ((consperc_08/consperc_98))^(1/10) -1
# NaN until 10th percentile ?

# c
plotgrowth<- data.frame(
  Percentile = percentiles * 100, 
  Growth8798 = growth98,
  Growth9808 = growth08
)

plotgrowth <- plotgrowth %>%
  pivot_longer(cols = starts_with("Growth"), names_to = "Period", values_to = "GrowthRate")

# Plot the Growth Incidence Curve
ggplot(plotgrowth, aes(x = Percentile, y = GrowthRate, color = Period)) +
  geom_line(size = 1) +
  labs(
    title = "Growth Incidence Curve (1987–1998 and 1998–2008)",
    x = "Percentiles of Per Capita Consumption",
    y = "Average Annual Growth Rate"
  ) +
  theme_minimal() +
  scale_color_manual(
    name = "Periods",
    values = c("Growth8798" = "lightblue", "Growth9808" = "violet"),
    labels = c("1987–1998", "1998–2008")
  ) +
  theme(
    legend.position = "bottom",
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    axis.title = element_text(size = 12)
  )+theme(
    plot.title = element_text(size = 8),     
    plot.subtitle = element_text(size = 7),  
    plot.caption = element_text(size = 7),
     axis.title.x = element_text(size = 6),
     axis.title.y = element_text(size=6),
    legend.text = element_text(size = 6),
        legend.title = element_text(size = 7)) 

  
```

The annual growth rate between 1987 and 1998 supports the results found in the poverty rates; growth rate in the 11 years period is negative and approximately equal to -4/% across the whole consumption distribution, with slightly more negative values for the top percentiles. In the 1998-2008 period average annual growth exhibits a more heterogeneous pattern, with negative values -even if higher than for the previous period- up until around the 85th percentile.

The pattern that we seem to observe is characterised by increasing inequality across time, with annual growth rate diverging for the lowest and highest percentiles of the consumption distribution. Consequently, we expect inequality to increase in 2008, with the richest experiencing higher growth compared to the poorest.

\newpage

## 5. Lorenz curves

We compute the Lorenz curves by showcasing the population percentiles on the x axis and the cumulative consumption on the y axis. The closer to the 45 degree line the Lorenz curve the lower the inequality observed.

```{r, fig.width=4, fig.height=4}
# Subset the data for each year
civ1987 <- subset(civ, year == 1987)
civ1998 <- subset(civ, year == 1998)
civ2008 <- subset(civ, year == 2008)

# Process 1987 data
consumption87 <- civ1987[order(civ1987$conspc87),] %>%
  mutate(
    cum_pop = cumsum(weight2) / sum(weight2),  # Cumulative population share
    cum_consump = cumsum(conspc87 * weight2) / sum(conspc87 * weight2)  # Cumulative consumption share
  )

# Process 1998 data
consumption98 <- civ1998[order(civ1998$conspc87),] %>%
  mutate(
    cum_pop = cumsum(weight2) / sum(weight2),  # Cumulative population share
    cum_consump = cumsum(conspc87 * weight2) / sum(conspc87 * weight2)  # Cumulative consumption share
  )

# Process 2008 data
consumption08 <- civ2008[order(civ2008$conspc87),] %>%
  mutate(
    cum_pop = cumsum(weight2) / sum(weight2),  # Cumulative population share
    cum_consump = cumsum(conspc87 * weight2) / sum(conspc87 * weight2)  # Cumulative consumption share
  )

# Combine all years into one dataset with a 'year' column
consumption_all <- bind_rows(
  consumption87 %>% mutate(year = 1987),
  consumption98 %>% mutate(year = 1998),
  consumption08 %>% mutate(year = 2008)
)

# Plot Lorenz Curves
plot1<-ggplot(consumption_all, aes(x = cum_pop, y = cum_consump / max(cum_consump))) +  # Normalize y-axis
  geom_line(aes(color = factor(year)), size = 1) +  # Plot lines for each year
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "black") +  # Add 45-degree line (equality line)
  scale_color_manual(values = c("1987" = "violet", "1998" = "darkblue", "2008" = "green4")) +  # Customize line colors
  labs(
    title = "Lorenz Curves in Cote d'Ivoire - National Level",
    x = "Cumulative Share of Population",
    y = "Cumulative Share of Consumption",
    color = "Year"
  ) +
  theme_classic() +  # Use a clean theme
  theme(
    plot.title = element_text(size = 8),
    plot.subtitle = element_text(size = 7),
    plot.caption = element_text(size = 7),
    axis.title.x = element_text(size = 6),
    axis.title.y = element_text(size = 6),
    legend.text = element_text(size = 6),
    legend.title = element_text(size = 7)
  )


```

```{r, fig.width=4, fig.height=3}


# Subset the data for each year and the North region (north == 1)
civ1987_north <- subset(civ, year == 1987 & north == 1)
civ1998_north <- subset(civ, year == 1998 & north == 1)
civ2008_north <- subset(civ, year == 2008 & north == 1)

# Process 1987 data for North region
consumption87_north <- civ1987_north[order(civ1987_north$conspc87),] 
consumption87_north <- consumption87_north %>%
  mutate(cum_pop = cumsum(weight2) / sum(weight2)) %>%
  mutate(cum_consump = cumsum(conspc87 * weight2) / sum(conspc87 * weight2))

# Process 1998 data for North region
consumption98_north <- civ1998_north[order(civ1998_north$conspc87),] 
consumption98_north <- consumption98_north %>%
  mutate(cum_pop = cumsum(weight2) / sum(weight2)) %>%
  mutate(cum_consump = cumsum(conspc87 * weight2) / sum(conspc87 * weight2))

# Process 2008 data for North region
consumption08_north <- civ2008_north[order(civ2008_north$conspc87),] 
consumption08_north <- consumption08_north %>%
  mutate(cum_pop = cumsum(weight2) / sum(weight2)) %>%
  mutate(cum_consump = cumsum(conspc87 * weight2) / sum(conspc87 * weight2))

# Combine all years for the North region into one dataset with a 'year' column
consumption_all_north <- bind_rows(
  consumption87_north %>% mutate(year = 1987),
  consumption98_north %>% mutate(year = 1998),
  consumption08_north %>% mutate(year = 2008)
) 

# Plot Lorenz Curves for the North region
plot2<-ggplot(consumption_all_north, aes(x = cum_pop, y = cum_consump / max(cum_consump))) +
  geom_line(aes(color = factor(year)), size = 1) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "black") +  # Add 45-degree line
  scale_color_manual(values = c("1987" = "violet", "1998" = "darkblue", "2008" = "green4")) +
  labs(
    title = "Lorenz Curves in Cote d'Ivoire - North Region",
    x = "Cumulative Share of Population",
    y = "Cumulative Share of Consumption",
    color = "Year"
  ) +
  theme_classic()+theme(
    plot.title = element_text(size = 8),     
    plot.subtitle = element_text(size = 7),  
    plot.caption = element_text(size = 7),
     axis.title.x = element_text(size = 6),
     axis.title.y = element_text(size=6),
    legend.text = element_text(size = 6),
        legend.title = element_text(size = 7)) 




```

```{r, fig.width=4, fig.height=7}


# Subset the data for each year and the North region (north == 0)
civ1987_south <- subset(civ, year == 1987 & north == 0)
civ1998_south <- subset(civ, year == 1998 & north == 0)
civ2008_south <- subset(civ, year == 2008 & north == 0)

# Process 1987 data for South region
consumption87_south <- civ1987_south[order(civ1987_south$conspc87),] 
consumption87_south <- consumption87_south %>%
  mutate(cum_pop = cumsum(weight2) / sum(weight2)) %>%
  mutate(cum_consump = cumsum(conspc87 * weight2) / sum(conspc87 * weight2))

# Process 1998 data for South region
consumption98_south <- civ1998_south[order(civ1998_south$conspc87),] 
consumption98_south <- consumption98_south %>%
  mutate(cum_pop = cumsum(weight2) / sum(weight2)) %>%
  mutate(cum_consump = cumsum(conspc87 * weight2) / sum(conspc87 * weight2))

# Process 2008 data for South region
consumption08_south <- civ2008_south[order(civ2008_south$conspc87),] 
consumption08_south <- consumption08_south %>%
  mutate(cum_pop = cumsum(weight2) / sum(weight2)) %>%
  mutate(cum_consump = cumsum(conspc87 * weight2) / sum(conspc87 * weight2))

# Combine all years for the South region into one dataset with a 'year' column
consumption_all_south <- bind_rows(
  consumption87_south %>% mutate(year = 1987),
  consumption98_south %>% mutate(year = 1998),
  consumption08_south %>% mutate(year = 2008)
) 

# Plot Lorenz Curves for the North region
plot3<-ggplot(consumption_all_south, aes(x = cum_pop,  y = cum_consump / max(cum_consump))) +
  geom_line(aes(color = factor(year)), size = 1) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "black") +  # Add 45-degree line
  scale_color_manual(values = c("1987" = "violet", "1998" = "darkblue", "2008" = "green4")) +
  labs(
    title = "Lorenz Curves in Cote d'Ivoire - South Region",
    x = "Cumulative Share of Population",
    y = "Cumulative Share of Consumption",
    color = "Year"
  ) +
  theme_classic()+theme(
    plot.title = element_text(size = 8),     
    plot.subtitle = element_text(size = 7),  
    plot.caption = element_text(size = 7),
     axis.title.x = element_text(size = 6),
     axis.title.y = element_text(size=6),
    legend.text = element_text(size = 6),
        legend.title = element_text(size = 7)) 

grid.arrange(plot1, plot2, plot3, ncol=1)
```

We observe higher inequality in 2008 compared to 1987 and 1998, which confirms our previous results and forecasting. Inequality does not vary drastically between 1998 and 1987 at every geographical level, while it is difficult to assess the differences between inequality in the North, South and at the National level.

**Crossing Lorenz Curves**

In order to individuate where the Lorenz curve cross we compute the pairwise differences between Lorenz curves at the national and regional level and observe whether such differences are zero at any percentile.

**National Level**

There is no observable crossing of the Lorenz curves at the national level.

```{r, fig.width=6, fig.height=4}

# Function to perform interpolation of cumulative consumption based on common cum_pop
interpolate_data <- function(data, common_cum_pop) {
  approx(data$cum_pop, data$cum_consump, xout = common_cum_pop, method = "linear", rule = 2)$y
}

# Create a common set of cumulative population values 
common_cum_pop <- seq(0, 1, length.out = 100)

# Interpolate data for 1987, 1998, and 2008 for the South region

# Interpolate for 1987
interpolated_87 <- data.frame(
  cum_pop = common_cum_pop,
  cum_consump_87 = interpolate_data(consumption87, common_cum_pop)
)

# Interpolate for 1998
interpolated_98 <- data.frame(
  cum_pop = common_cum_pop,
  cum_consump_98 = interpolate_data(consumption98, common_cum_pop)
)

# Interpolate for 2008
interpolated_08 <- data.frame(
  cum_pop = common_cum_pop,
  cum_consump_08 = interpolate_data(consumption08, common_cum_pop)
)

# Combine the interpolated data into one dataframe
interpolated_data <- interpolated_87 %>%
  left_join(interpolated_98, by = "cum_pop") %>%
  left_join(interpolated_08, by = "cum_pop")

# Calculate the differences between the years
interpolated_data <- interpolated_data %>%
  mutate(
    diff_87_98 = cum_consump_87 - cum_consump_98,
    diff_87_08 = cum_consump_87 - cum_consump_08,
    diff_98_08 = cum_consump_98 - cum_consump_08
  )

# Reshape data for plotting
pairwise_diff_all <- interpolated_data %>%
  select(cum_pop, diff_87_98, diff_87_08, diff_98_08) %>%
  gather(key = "comparison", value = "diff", -cum_pop)


ggplot(pairwise_diff_all, aes(x = cum_pop, y = diff, color = comparison)) +
  geom_line(size = 1) +
  scale_color_manual(values = c("diff_87_98" = "violet", 
                                "diff_87_08" = "darkblue", 
                                "diff_98_08" = "green4")) +
  labs(
    title = "Pairwise Differences in Lorenz Curves - National",
    x = "Cumulative Share of Population",
    y = "Difference in Cumulative Consumption",
    color = "Comparison"
  ) +
  facet_wrap(~ comparison, scales = "free_y") +  
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +  
  theme_classic() +
  theme(
    plot.title = element_text(size = 8),     
    plot.subtitle = element_text(size = 7),  
    plot.caption = element_text(size = 7),
    axis.title.x = element_text(size = 6),
    axis.title.y = element_text(size = 6),
    legend.text = element_text(size = 6),
    legend.title = element_text(size = 7)
  )
```

**Regional Level**

We compute the pairwise differences in cumulative consumption at the regional level, observing none of little crossing around the 99th percentile in the North. The only clear crossing of the Lorenz Curves across years is at the Southern Regional level, with the curves for 1987 and 1998 crossing around the 75th percentile.

```{r, fig.width=6, fig.height=4}



# Function to perform interpolation of cumulative consumption based on common cum_pop
interpolate_data <- function(data, common_cum_pop) {
  approx(data$cum_pop, data$cum_consump, xout = common_cum_pop, method = "linear", rule = 2)$y
}

# Create a common set of cumulative population values
common_cum_pop <- seq(0, 1, length.out = 100)

# Interpolate data for 1987, 1998, and 2008 for the South region

# Interpolate for 1987
interpolated_87 <- data.frame(
  cum_pop = common_cum_pop,
  cum_consump_87 = interpolate_data(consumption87_south, common_cum_pop)
)

# Interpolate for 1998
interpolated_98 <- data.frame(
  cum_pop = common_cum_pop,
  cum_consump_98 = interpolate_data(consumption98_south, common_cum_pop)
)

# Interpolate for 2008
interpolated_08 <- data.frame(
  cum_pop = common_cum_pop,
  cum_consump_08 = interpolate_data(consumption08_south, common_cum_pop)
)

# Combine the interpolated data into one dataframe
interpolated_data <- interpolated_87 %>%
  left_join(interpolated_98, by = "cum_pop") %>%
  left_join(interpolated_08, by = "cum_pop")

# Calculate the differences between the years
interpolated_data <- interpolated_data %>%
  mutate(
    diff_87_98 = cum_consump_87 - cum_consump_98,
    diff_87_08 = cum_consump_87 - cum_consump_08,
    diff_98_08 = cum_consump_98 - cum_consump_08
  )

# Reshape data for plotting
pairwise_diff_all <- interpolated_data %>%
  select(cum_pop, diff_87_98, diff_87_08, diff_98_08) %>%
  gather(key = "comparison", value = "diff", -cum_pop)


ggplot(pairwise_diff_all, aes(x = cum_pop, y = diff, color = comparison)) +
  geom_line(size = 1) +
  scale_color_manual(values = c("diff_87_98" = "violet", 
                                "diff_87_08" = "darkblue", 
                                "diff_98_08" = "green4")) +
  labs(
    title = "Pairwise Differences in Lorenz Curves - South Region",
    x = "Cumulative Share of Population",
    y = "Difference in Cumulative Consumption",
    color = "Comparison"
  ) +
  facet_wrap(~ comparison, scales = "free_y") + 
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +  
  theme_classic() +
  theme(
    plot.title = element_text(size = 8),     
    plot.subtitle = element_text(size = 7),  
    plot.caption = element_text(size = 7),
    axis.title.x = element_text(size = 6),
    axis.title.y = element_text(size = 6),
    legend.text = element_text(size = 6),
    legend.title = element_text(size = 7)
  )

```

```{r, fig.width=6, fig.height=4}



# Function to perform interpolation of cumulative consumption based on common cum_pop
interpolate_data <- function(data, common_cum_pop) {
  approx(data$cum_pop, data$cum_consump, xout = common_cum_pop, method = "linear", rule = 2)$y
}

# Create a common set of cumulative population values 
common_cum_pop <- seq(0, 1, length.out = 100)

# Interpolate data for 1987, 1998, and 2008 for the North region

# Interpolate for 1987 (North)
interpolated_87_north <- data.frame(
  cum_pop = common_cum_pop,
  cum_consump_87_north = interpolate_data(consumption87_north, common_cum_pop)
)

# Interpolate for 1998 (North)
interpolated_98_north <- data.frame(
  cum_pop = common_cum_pop,
  cum_consump_98_north = interpolate_data(consumption98_north, common_cum_pop)
)

# Interpolate for 2008 (North)
interpolated_08_north <- data.frame(
  cum_pop = common_cum_pop,
  cum_consump_08_north = interpolate_data(consumption08_north, common_cum_pop)
)

# Combine the interpolated data into one dataframe
interpolated_data_north <- interpolated_87_north %>%
  left_join(interpolated_98_north, by = "cum_pop") %>%
  left_join(interpolated_08_north, by = "cum_pop")

# Calculate the differences between the years
interpolated_data_north <- interpolated_data_north %>%
  mutate(
    diff_87_98_north = cum_consump_87_north - cum_consump_98_north,
    diff_87_08_north = cum_consump_87_north - cum_consump_08_north,
    diff_98_08_north = cum_consump_98_north - cum_consump_08_north
  )

# Reshape data for plotting
pairwise_diff_all_north <- interpolated_data_north %>%
  select(cum_pop, diff_87_98_north, diff_87_08_north, diff_98_08_north) %>%
  gather(key = "comparison", value = "diff", -cum_pop)



# Create separate plots for each comparison
ggplot(pairwise_diff_all_north, aes(x = cum_pop, y = diff, color = comparison)) +
  geom_line(size = 1) +
  scale_color_manual(values = c("diff_87_98_north" = "violet", 
                                "diff_87_08_north" = "darkblue", 
                                "diff_98_08_north" = "green4")) +
  labs(
    title = "Pairwise Differences in Lorenz Curves - North Region",
    x = "Cumulative Share of Population",
    y = "Difference in Cumulative Consumption",
    color = "Comparison"
  ) +
  facet_wrap(~ comparison, scales = "free_y") + 
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +  
  theme_classic() +
  theme(
    plot.title = element_text(size = 8),     
    plot.subtitle = element_text(size = 7),  
    plot.caption = element_text(size = 7),
    axis.title.x = element_text(size = 6),
    axis.title.y = element_text(size = 6),
    legend.text = element_text(size = 6),
    legend.title = element_text(size = 7)
  )

```

\newpage

### Complete Code

```{r ref.label=all_labels(), echo=T, eval=FALSE}

```
