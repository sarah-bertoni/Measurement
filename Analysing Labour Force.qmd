---
title: "Homework V"
author: "Sarah Bertoni"
date: 20 February 2024
format:
  pdf: 
    fontsize: 9pt
    mainfont: Garamond
    sansfont: Garamond
editor: visual
output: 
  html_document:
    theme: cosmo
    latex_engine: pdflatex
    huxreg_options: "tabular={l|ccc}, tablewidth=0.1\\textwidth, tablefont=\\footnotesize"
    fig_caption: true
execute:
  echo: false
  warning: false
prefer-html: true
---

```{r}
library("modelsummary")
library("haven")
library("tidyverse")
library("kableExtra")
library("stargazer")
library("huxtable")
library("knitr")
library("spatstat")
library("gridExtra")
library(tinytable)
```

# Analyzing the French labor force

```{r}
lfs_11<-read_dta("lfshwk_fr11.dta")
lfs_12<-read_dta("lfshwk_fr12.dta")
```


```{r}


variables <- data.frame(
  Variable = c("TRAREF", "PASTRA", "RABS:", "RABS (1)",
               "RABS (2)", "RABS (3)", "RABS (4)", "RABS (5)",
               "RABS (6)", "RABS (7)", "RABS (8)", "RABS (9)",
               "RABS (10)", "RABS (11)", "AIDFAM", "RATTRAP", "TEMP"),
  Definition = c("Has a job during the reference week.",
                 "Have a job from which they are absent under certain conditions of reason.",
                 "Reason for absence",
                 "Paid leave, including RTT days.",
                 "Sick leave, including child care, work accident.",
                 "Maternity or paternity leave, depending on gender.",
                 "Part-time work.",
                 "Parental leave.",
                 "Other unpaid leave.",
                 "Employer-paid training or training under an apprenticeship contract.",
                 "Partial unemployment, technical unemployment.",
                 "Suspension, end of employment period.",
                 "Strike.",
                 "Off-season period in a seasonal activity, or period preceding the start of employment.",
                 "Work without pay with a member of their family.",
                 "Had a sideline or a small paid job.",
                 "People aged 75 or over who have a job, even for a few hours, as employees or self-employed.")
)

kable(variables, format = "markdown", col.names = c("Variable", "Definition"), escape = FALSE, caption = "Variables and Definitions for Employment") %>%
  kable_classic_2(full_width = F) %>%
  column_spec(1, bold=T, border_right = T) %>%
  column_spec(2, width = "30em") %>% 
  row_spec(0, bold=T) 

```

```{r}
lfshwk_fr11 <- read_dta("lfshwk_fr11.dta")
#define variable for employement:
dataset <- lfshwk_fr11
dataset <- dataset %>% mutate(employed= case_when(traref==1~ 1,
                                           (pastra == 1 & rabs %in% c(1, 2, 3, 4, 7, 8, 10)) ~1,
                                           (pastra==1 & c(rabs== 5|rabs==6) &  rabsp <= 91)~1,
                        temp==1 ~1,
                        aidref == 1 ~ 1,
                         if_all(c(traref, pastra, rabs, rabsp, aidref, temp), is.na) ~ NA_integer_, .default = 0))
```


```{r}
variables_new <- data.frame(
  Variable = c("TRAREF", "DISPOC", "DEM","ULTJ"),
  Definition = c("Has a job during the reference week.",
                 "Available for work",
                 "Active job search", "Time period before the start of next job")
)

kable(variables_new, format = "markdown", col.names = c("Variable", "Definition"), escape = FALSE, caption = "Variables and Definitions for Unemployment") %>%
  kable_classic_2(full_width = F) %>%
  column_spec(1, bold=T, border_right = T) %>%
  column_spec(2, width = "30em") %>% 
  row_spec(0, bold=T) 



```

```{r}

dataset <- dataset %>% mutate(unemployed= case_when(employed==0 & dispoc == 1 & (dem==1|ultj< 91) ~1,
                         is.na(traref) ~ NA_integer_, .default = 0))
```

```{r}
lfshwk_fr12 <- read_dta("lfshwk_fr12.dta")
dataset12<- lfshwk_fr12

dataset12 <- dataset12 %>% mutate(employed= case_when(traref==1~ 1,
                                           (pastra == 1 & rabs %in% c(1, 2, 3, 4, 7, 8, 10)) ~1,
                                           (pastra==1 & c(rabs== 5|rabs==6) &  rabsp <= 91)~1,
                        temp==1 ~1,
                        aidref == 1 ~ 1,
                         if_all(c(traref, pastra, rabs, rabsp, aidref, temp), is.na) ~ NA_integer_, .default = 0))
dataset12 <- dataset12 %>% mutate(unemployed= case_when(employed==0 & dispoc == 1 & (dem==1|ultj< 91) ~1,
                         is.na(traref) ~ NA_integer_, .default = 0))
```

**Employment Rates**

Rates, shares and graphs are thereafter computed through the IINSEE definitions and dataset.


```{r}
lm11_75<- lm(data=dataset[dataset$ag<75,], formula= employed ~1, weights = weight)
lm11_65<- lm(data=dataset[dataset$ag<65,], formula= employed ~1, weights = weight)
lm11_tot<- lm(data=dataset, formula= employed ~1, weights = weight)

lm12_65<- lm(data=dataset12[dataset12$ag<65,], formula= employed ~1, weights = weight)
lm12_75<- lm(data=dataset12[dataset12$ag<75,], formula= employed ~1, weights = weight)
lm12_tot<- lm(data=dataset12, formula= employed ~1, weights = weight)


names(lm11_65$coefficients)[1]<- "[age 15-65]"
names(lm11_75$coefficients)[1]<- "[age 15-75]"
names(lm11_tot$coefficients)[1]<- "[total population]"
names(lm12_65$coefficients)[1]<- "[age 15-65]"
names(lm12_75$coefficients)[1]<- "[age 15-75]"
names(lm12_tot$coefficients)[1]<- "[total population]"

rates_empl <- huxreg("2011 [age 15-65]" = lm11_65, 
                       "2011 [age 15-75]" = lm11_75,
                      "2011 [total population]" = lm11_tot,

                       "2012 [age 15-65]" = lm12_65,
                       "2012 [age 15-75]" = lm12_75,
                                           "2012 [total population]" = lm12_tot,

                  error_format = "({std.error})",
                  error_pos = "below",
                  statistics = c(N = "nobs"),
                  note = "{stars}",
                  align = "center") %>%
  set_caption("Employement Rates")


rates_empl_65 <- huxreg("2011" = lm11_65, "2012" = lm12_65,
       statistics = c(N = "nobs"))
rates_empl_75 <- huxreg("2011" = lm11_75, "2012" = lm12_75,
       statistics = c(N = "nobs"))
rates_empl_tot<- huxreg("2011" = lm11_tot, "2012" = lm12_tot,
       statistics = c(N = "nobs"))

table_4 <- rbind(rates_empl_65[1:3,], rates_empl_75[2:3,], rates_empl_tot[2:4,])
caption(table_4) <- c("Employement Rates")
set_latex_float(table_4, value = "H")

```


**Uneployment Rates**

The unemployment rate has to be computed over the economically active population, not on the total population, differently form the employment rate. We therefore define the economically active population as the sum of employed and unemployed.

```{r}
dataset <- dataset %>%  mutate(active=ifelse(employed==1|unemployed==1, 1, 0))
dataset12 <- dataset12 %>%  mutate(active=ifelse(employed==1|unemployed==1, 1, 0))
```

```{r}
lm11_75u<- lm(data=dataset[(dataset$ag<75 & dataset$active==1),], formula= unemployed ~1, weights = weight)
lm11_65u<- lm(data=dataset[(dataset$ag<65 & dataset$active==1),], formula= unemployed ~1, weights = weight)
lm11utot<- lm(data=dataset[( dataset$active==1),], formula= unemployed ~1, weights = weight)

lm12_65u<- lm(data=dataset12[(dataset12$ag<65& dataset12$active==1),], formula= unemployed ~1, weights = weight)
lm12_75u<- lm(data=dataset12[(dataset12$ag<75& dataset12$active==1),], formula= unemployed ~1, weights = weight)
lm12utot<- lm(data=dataset12[( dataset12$active==1),], formula= unemployed ~1, weights = weight)

names(lm11_65u$coefficients)[1]<- "[age 15-65]"
names(lm11_75u$coefficients)[1]<- "[age 15-75]"
names(lm11utot$coefficients)[1]<- "[total population]"
names(lm12_65u$coefficients)[1]<- "[age 15-65]"
names(lm12_75u$coefficients)[1]<- "[age 15-75]"
names(lm12utot$coefficients)[1]<- "[total population]"


rates_unempl_65 <- huxreg("2011" = lm11_65u, "2012" = lm12_65u,
       statistics = c(N = "nobs"))
rates_unempl_75 <- huxreg("2011" = lm11_75u, "2012" = lm12_75u,
       statistics = c(N = "nobs"))
rates_unempl_tot<- huxreg("2011" = lm11utot, "2012" = lm12utot,
       statistics = c(N = "nobs"))

table_5 <- rbind(rates_unempl_65[1:3,], rates_unempl_75[2:3,], rates_unempl_tot[2:4,])
caption(table_4) <- c("Unmployement Rates")
set_latex_float(table_5, value = "H")



```



## c) Own definition of unemployment

The official definition of unemployment has been often critised because it excludes from the labour force those who are not looking for work, ie. discouraged workers.

This relates to the broader problem of "unemployment halo" and the widespread criticism according to which ILO offical unemployment rates severely underestimate the "true" extent of unemployment. According to the insee definition, the unemployment halo consists of unemployed people who are either looking for work but are not available to work within two weeks, or who have not actively looked for work in the previous month but would like to work, whether or not they are available.

The halo therefore includes people who , while being part of the inactive population as per following of the official requirements defined by the ILO (neither employed nor unemployed), are close to the labour market.

To correct for such underestimation of the unemployment rate we computed ab adjusted rate: we include in the definition of unemployment people available for a job but not actively seeking, as they relate to people that may be discouraged in the reasearch but would accept a job if offered one.

We therefore re-calculate unemployment rates including individuals:

1\) seeking a job but not immediately available

2\) available for a job but not actively seeking

3\) not seeking and not immediately available

Our definition of unemployment is therefore simply the share of people over 15 years old who are involuntarily without work on the as such newly defined active population. We also elongate the period for the start of a future job to 300 days to account for people waiting for the next job. For semplicity, we focus on the working age population defined as in the 15-65 age range.

```{r}
dataset <- dataset %>% mutate(unemployed2= case_when(traref==2 & dispoc == 1 & (dem==1|ultj< 91) ~1, (employed==0 & dispoc == 0 & (dem==1|ultj< 91)) ~1, (employed==0 & dispoc == 0 & (dem==0|ultj< 91)) ~1, (employed==0 & dispoc == 0 & (dem==0|ultj< 300)) ~1,
                         is.na(traref) ~ NA_integer_, .default = 0))

dataset12 <- dataset12 %>% mutate(unemployed2= case_when(traref==2 & dispoc == 1 & (dem==1|ultj< 91) ~1, (employed==0 & dispoc == 0 & (dem==1|ultj< 300)) ~1, (employed==0 & dispoc == 0 & (dem==0|ultj< 91)) ~1, (employed==0 & dispoc == 0 & (dem==0|ultj< 300)) ~1,
                         is.na(traref) ~ NA_integer_, .default = 0))


dataset <- dataset %>%  mutate(activenew=ifelse(employed==1|unemployed2==1, 1, 0))
dataset12 <- dataset12 %>%  mutate(activenew=ifelse(employed==1|unemployed2==1, 1, 0))


lm11_65unew<- lm(data=dataset[(dataset$ag<65 & dataset$activenew==1),], formula= unemployed2 ~1, weights = weight)


lm12_65unew<- lm(data=dataset12[(dataset12$ag<65 & dataset12$activenew==1),], formula= unemployed2 ~1, weights = weight)

names(lm11_65unew$coefficients)[1]<- "Rate"
names(lm12_65unew$coefficients)[1]<- "Rate"


rates_unempl2 <- huxreg("2011" = lm11_65u, 
                      
                       "2012" = lm12_65u,
                     
                       
                       
                  error_format = "({std.error})",
                  error_pos = "below",
                  statistics = c(N = "nobs"),
                  note = "{stars}",
                  align = "center") 

rates_unempl_new <- huxreg("2011" = lm11_65unew, 
                       
                       
                       "2012" = lm12_65unew,
                      
                       
                       
                  error_format = "({std.error})",
                  error_pos = "below",
                  statistics = c(N = "nobs"),
                  note = "{stars}",
                  align = "center") %>% set_caption("Unemployment Rates Adjusted [age 15-65]")

table_5 <- cbind(rates_unempl2[2:3], rates_unempl_new[2:3])  

set_latex_float(rates_unempl_new, value = "H")

```

## d) Standard errors

```{r}
x <- sqrt(0.092*(1-0.092)/nrow(dataset))
y <- sqrt(0.098*(1-0.098)/nrow(dataset12))
```

-   For 2011: we have $\hat{u}_{2011}$ = 0.092 Since $n= 423425$ observations: $$\hat{\sigma}_{2011} = \sqrt\frac{0.092\times0.908}{423424}$$ = `r round(x, 5)`.

-   For 2012: we have $\hat{u}_{2012}$ = 0.098 with $n= 422133$ $$\Longrightarrow \hat{\sigma}_{2012} = \sqrt\frac{0.098\times0.902}{422132}$$ = `r round(y, 5)`.



## e) Evolution

To analyse the evolution of the composition of the working age population we compute unemployment and employment shares for each quarter, making up the active population; differently from the rates, unemployment shares are computed over the whole working age population, not only the active one. We define the inactive population as consisting of all those individuals who are neither employed nor unemployed and compute the relative share.

### 2011

```{r}
dataset <- dataset %>%  mutate(inactive=ifelse(employed==0 & unemployed==0, 1, 0))
dataset12 <- dataset12 %>%  mutate(inactive=ifelse(employed==0&unemployed==0, 1, 0))

lm11_1<- lm(data=dataset[(dataset$ag<65  & dataset$trim==1 ),], formula= unemployed ~1, weights = weight)


lm11_2<- lm(data=dataset[(dataset$ag<65 & dataset$trim==2 ),], formula= unemployed ~1, weights = weight)

lm11_3<- lm(data=dataset[(dataset$ag<65 & dataset$trim==3),], formula= unemployed ~1, weights = weight)

names(lm11_1$coefficients)[1]<- "Unemployment Share"
names(lm11_2$coefficients)[1]<- "Unemployment Share"
names(lm11_3$coefficients)[1]<- "Unemployment Share"



```

```{r}

lm11_65Q1<- lm(data=dataset[(dataset$ag<65 & dataset$trim==1 ),], formula= employed ~1, weights = weight)

lm11_65Q2<- lm(data=dataset[(dataset$ag<65 & dataset$trim==2 ),], formula= employed ~1, weights = weight)
lm11_65Q3<- lm(data=dataset[(dataset$ag<65 & dataset$trim==3 ),], formula= employed ~1, weights = weight)



names(lm11_65Q1$coefficients)[1]<- "Employment Share"

names(lm11_65Q2$coefficients)[1]<- "Employment Share"
names(lm11_65Q3$coefficients)[1]<- "Employment Share"


```

```{r}
lm11_1in<- lm(data=dataset[(dataset$ag<65  & dataset$trim==1 ),], formula= inactive ~1, weights = weight)


lm11_2in<- lm(data=dataset[(dataset$ag<65 & dataset$trim==2 ),], formula= inactive ~1, weights = weight)

lm11_3in<- lm(data=dataset[(dataset$ag<65 & dataset$trim==3 ),], formula= inactive ~1, weights = weight)


names(lm11_1in$coefficients)[1]<- "Inactive Share"
names(lm11_2in$coefficients)[1]<- "Inactive Share"
names(lm11_3in$coefficients)[1]<- "Inactive Share"



table_empl <- huxreg("Q1" = lm11_65Q1, "Q2" = lm11_65Q2, "Q3" = lm11_65Q3,
       statistics = c(N = "nobs"), note = NULL)
table_unempl <- huxreg("Q1" = lm11_1, "Q2" = lm11_2, "Q3" = lm11_3,
       statistics = c(N = "nobs"), note = NULL)
table_inac <- huxreg("Q1" = lm11_1in, "Q2" = lm11_2in, "Q3" = lm11_3in,
       statistics = c(N = "nobs"), note = NULL)


table_6 <- rbind(table_empl[1:3,], table_unempl[2:3,], table_inac[2:4,])
caption(table_6) <- c("2011 shares per Quarter [age 15-65]")
table_6
```



```{r, fig.width=4, fig.height=3}

results <- data.frame(
  Quarter = rep(c("Q1", "Q2", "Q3"), times = 3),  # Trim values (Q1, Q2, Q3)
  Category = rep(c("employed", "unemployed", "inactive"), each = 3),
  Share = c(
    lm11_65Q1$coefficients[1],  # empl Q1
    lm11_65Q2$coefficients[1],  # empl Q2
    lm11_65Q3$coefficients[1],  # empl Q3
    lm11_1$coefficients[1],  # unempl Q1
    lm11_2$coefficients[1],  # unempl Q2
    lm11_3$coefficients[1],  # unempl Q3
    lm11_1in$coefficients[1],  # inac Q1
    lm11_2in$coefficients[1],  # inac Q2
    lm11_3in$coefficients[1]   # inac Q3
  )
)

#pivot long
results_long <- results %>%
  gather(key = "Variable", value = "Value", Share)

#  plot
ggplot(results_long, aes(x = factor(Quarter), y = Value, fill = Category)) +
  geom_bar(stat = "identity", position = "stack", width = 0.7) +
  labs(title = "Composition of working age population in 2011", 
       x = "Quarter", 
       y = "Share",
       fill = "Category") +
  scale_fill_manual(values = c("employed" = "beige", "unemployed" ="#918380", "inactive" = "#d2aea7")) +
  theme_minimal()+
  theme(
    legend.position = "right",
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    axis.title = element_text(size = 12)
  )+theme(
    plot.title = element_text(size = 8),     
    plot.subtitle = element_text(size = 7),  
    plot.caption = element_text(size = 7),
     axis.title.x = element_text(size = 6),
     axis.title.y = element_text(size=6),
    legend.text = element_text(size = 6),
        legend.title = element_text(size = 7)) 
```

Overall, in 2011 we observe a quite stable quarterly composition of the working age population.

### 2012

```{r}
lm12_1 <- lm(data=dataset12[(dataset12$ag<65 & dataset12$trim==1 ),], formula= unemployed ~1, weights = weight)
lm12_2 <- lm(data=dataset12[(dataset12$ag<65 & dataset12$trim==2 ),], formula= unemployed ~1, weights = weight)

names(lm12_1$coefficients)[1] <- "Unemployment Share"
names(lm12_2$coefficients)[1] <- "Unemployment Share"

lm12_65Q1 <- lm(data=dataset12[(dataset12$ag<65 & dataset12$trim==1 ),], formula= employed ~1, weights = weight)
lm12_65Q2 <- lm(data=dataset12[(dataset12$ag<65 & dataset12$trim==2 ),], formula= employed ~1, weights = weight)

names(lm12_65Q1$coefficients)[1] <- "Employment Share"
names(lm12_65Q2$coefficients)[1] <- "Employment Share"

lm12_1in <- lm(data=dataset12[(dataset12$ag<65 & dataset12$trim==1 ),], formula= inactive ~1, weights = weight)
lm12_2in <- lm(data=dataset12[(dataset12$ag<65 & dataset12$trim==2 ),], formula= inactive ~1, weights = weight)

names(lm12_1in$coefficients)[1] <- "Inactive Share"
names(lm12_2in$coefficients)[1] <- "Inactive Share"

#  combining the tables 
table_empl <- huxreg("Q1" = lm12_65Q1, "Q2" = lm12_65Q2,
       statistics = c(N = "nobs"), note = NULL)

table_unempl <- huxreg("Q1" = lm12_1, "Q2" = lm12_2,
       statistics = c(N = "nobs"), note = NULL)

table_inac <- huxreg("Q1" = lm12_1in, "Q2" = lm12_2in, 
       statistics = c(N = "nobs"), note = NULL)
table_6 <- rbind(table_empl[1:3,], table_unempl[2:3,], table_inac[2:4,])
caption(table_6) <- c("2012 Shares per Quarter [age 15-65]")
table_6
```


```{r, fig.width=4, fig.height=3}

results12 <- data.frame(
  Quarter = rep(c("Q1", "Q2"), times = 3),  # Trim values (Q1, Q2)
  Category = rep(c("employed", "unemployed", "inactive"), each = 2),
  Share = c(
    lm12_65Q1$coefficients[1],  # empl Q1
    lm12_65Q2$coefficients[1],  # empl Q2
   
    lm12_1$coefficients[1],  # unempl Q1
    lm12_2$coefficients[1],  # unempl Q2
  
    lm12_1in$coefficients[1],  # inac Q1
    lm12_2in$coefficients[1])  # inac Q2
  
)

#pivot long
results12_long <- results12 %>%
  gather(key = "Variable", value = "Value", Share)

#  plot
ggplot(results12_long, aes(x = factor(Quarter), y = Value, fill = Category)) +
  geom_bar(stat = "identity", position = "stack", width = 0.7) +
  labs(title = "Composition of working age population in 2012", 
       x = "Quarter", 
       y = "Share",
       fill = "Category") +
  scale_fill_manual(values = c("employed" = "beige", "unemployed" ="#918380", "inactive" = "#d2aea7")) +
  theme_minimal()+
  theme(
    legend.position = "right",
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    axis.title = element_text(size = 12)
  )+theme(
    plot.title = element_text(size = 8),     
    plot.subtitle = element_text(size = 7),  
    plot.caption = element_text(size = 7),
     axis.title.x = element_text(size = 6),
     axis.title.y = element_text(size=6),
    legend.text = element_text(size = 6),
        legend.title = element_text(size = 7)) 
```

## f) Unemployment rate and labor force participation by characteristics

We compute the unemployment rate and labor force participation by demographics, according to the official definition.


```{r}
# Gender
wmu <- lm(data=dataset12[(dataset12$ag<65 & dataset12$sexe==2 & dataset12$active==1),], formula= unemployed ~1, weights = weight)
menu <- lm(data=dataset12[(dataset12$ag<65 & dataset12$sexe==1 & dataset12$active==1),], formula= unemployed ~1, weights = weight)
wmlf <- lm(data=dataset12[(dataset12$ag<65 & dataset12$sexe==2 ),], formula= active ~1, weights = weight)
menlf <- lm(data=dataset12[(dataset12$ag<65 & dataset12$sexe==1 ),], formula= active ~1, weights = weight)

women <- huxreg("Unemployment" = wmu, "Labour Force" = wmlf,
       statistics = c(N = "nobs"), coefs = c("Women:" = "(Intercept)"), note = NULL)
men <- huxreg("Unemployment" = menu, "Labour Force" = menlf,
       statistics = c(N = "nobs"), coefs = c("Men:" = "(Intercept)"), note = NULL)


table_women <- rbind(women[1:3,], men[2:3,])
caption(table_women) <- c("Rates by Gender 2012")



results <- data.frame(
  Category = rep(c("Unemployed", "Labour Force"), each = 2),  # Categories for unemployed and labour force
  Gender = rep(c("Women", "Men"), times = 2),  # Gender
  Share = c(
    coef(wmu)[1],  # Women: Unemployment
    coef(menu)[1],  # Men: Unemployment
    coef(wmlf)[1],  # Women: Labour Force
    coef(menlf)[1]   # Men: Labour Force
  )
)

# Pivot the data to long format
results_long <- results %>%
  gather(key = "Variable", value = "Value", Share)

# Plot using ggplot2
plot1 <- ggplot(results_long, aes(x = Gender, y = (100*Value), fill = Category)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.7) +
  labs(title = "Unemployment and Labour Force Rates % by Gender", 
       x = "Gender", 
       y = "Rate (%)",
       fill = "Category") +
  scale_fill_manual(values = c("Unemployed" = "lightgoldenrod1", "Labour Force" = "burlywood")) +
  theme_minimal() +
  theme(
    legend.position = "right",
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    axis.title = element_text(size = 12)
  ) +
  theme(
    plot.title = element_text(size = 8),     
    plot.subtitle = element_text(size = 7),  
    plot.caption = element_text(size = 7),
    axis.title.x = element_text(size = 6),
    axis.title.y = element_text(size = 6),
    legend.text = element_text(size = 6),
    legend.title = element_text(size = 7)
  )

set_latex_float(table_women, "H") 

```

```{r}
##age

ageuhigher <- lm(data=dataset12[((dataset12$ag>=50 & dataset12$ag<65 & dataset12$active==1)),], 
                 formula= unemployed ~1, weights = weight)

ageulower <- lm(data=dataset12[(dataset12$ag<24 & dataset12$active==1),], 
                formula= unemployed ~1, weights = weight)

ageumiddle <- lm(data=dataset12[((dataset12$ag>=24 & dataset12$ag<=50) & dataset12$active==1),], formula= unemployed ~1, weights = weight)

ageufhigher <- lm(data=dataset12[((dataset12$ag>=50 & dataset12$ag<65)),], 
                  formula= active ~1, weights = weight)

ageuflower <- lm(data=dataset12[(dataset12$ag<24),], 
                 formula= active ~1, weights = weight)

ageufmiddle <- lm(data=dataset12[((dataset12$ag>=24 & dataset12$ag<=50)),], 
                  formula= active ~1, weights = weight)

higher <- huxreg("Unemployment" = ageuhigher, "Labour Force" = ageufhigher,
       statistics = c(N = "nobs"), coefs = c("Age 50-64:" = "(Intercept)"), note = NULL)

lower <- huxreg("Unemployment" = ageulower, "Labour Force" = ageuflower,
       statistics = c(N = "nobs"), coefs = c("Age 15-24:" = "(Intercept)"), note = NULL)

middle <- huxreg("Unemployment" = ageumiddle, "Labour Force" = ageufmiddle,
       statistics = c(N = "nobs"), coefs = c("Age 25-50:" = "(Intercept)"), note = NULL)

# Combine the tables for output
table_age <- rbind(higher[1:3,], middle[2:3,],lower[2:4,])
caption(table_age) <- c("Rates by Age Group 2012")


# Create a data frame with coefficients for each age group
results_age <- data.frame(
  Category = rep(c("Unemployed", "Labour Force"), each = 3),  # Categories for unemployment and labour force
  AgeGroup = rep(c("Age 15-24", "Age 25-50", "Age 50-64"), times = 2),  # Age groups
  Share = c(
    coef(ageulower)[1],  # Age 15-24: Unemployment
    coef(ageumiddle)[1],  # Age 25-50: Unemployment
    coef(ageuhigher)[1],  # Age 50-64: Unemployment
    coef(ageuflower)[1],  # Age 15-24: Labour Force
    coef(ageufmiddle)[1],  # Age 25-50: Labour Force
    coef(ageufhigher)[1]   # Age 50-64: Labour Force
  )
)


results_age_long <- results_age %>%
  gather(key = "Variable", value = "Value", Share)


plot2 <- ggplot(results_age_long, aes(x = AgeGroup, y = (100 * Value), fill = Category)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.7) +  # Use "dodge" for side-by-side bars
  labs(title = "Unemployment and Labour Force Rates % by Age Group  2012", 
       x = "Age Group", 
       y = "Rate (%)",
       fill = "Category") +
  scale_fill_manual(values = c("Unemployed" = "lightgoldenrod1", "Labour Force" = "burlywood")) +
  theme_minimal() +
  theme(
    legend.position = "right",
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    axis.title = element_text(size = 12)
  ) +
  theme(
    plot.title = element_text(size = 8),     
    plot.subtitle = element_text(size = 7),  
    plot.caption = element_text(size = 7),
    axis.title.x = element_text(size = 6),
    axis.title.y = element_text(size = 6),
    legend.text = element_text(size = 6),
    legend.title = element_text(size = 7)
  )

set_latex_float(table_age, "H") 

```

```{r}

dataset12 <- dataset12 %>%
  mutate(
    Education = case_when(
      ddipl == 1 ~ "Higher than BAC",     # Higher than BAC
      ddipl == 3 ~ "High School or Lower", # BAC +2
      ddipl == 4 ~ "High School or Lower", # BAC
      ddipl == 5 ~ "Vocational Diploma",   # CAP/BEP (Vocational)
      ddipl == 6 ~ "High School or Lower", # Brevet des coll√®ges
      ddipl == 7 ~ "High School or Lower", # Primary
      TRUE ~ "Unknown"                     # Handle unexpected values
    )
  )


age_diploma_high <- lm(data=dataset12[(dataset12$ag<65 & dataset12$Education == "Higher than BAC" & dataset12$active == 1),], 
                       formula= unemployed ~1, weights = weight)

age_diploma_voc <- lm(data=dataset12[(dataset12$ag<65 & dataset12$Education == "Vocational Diploma" & dataset12$active == 1),], 
                      formula= unemployed ~1, weights = weight)

age_diploma_low <- lm(data=dataset12[(dataset12$ag<65 & dataset12$Education == "High School or Lower" & dataset12$active == 1),], 
                      formula= unemployed ~1, weights = weight)

# Labour force models for the same categories
age_diploma_high_labour <- lm(data=dataset12[(dataset12$ag<65 & dataset12$Education == "Higher than BAC"),], 
                              formula= active ~1, weights = weight)

age_diploma_voc_labour <- lm(data=dataset12[(dataset12$ag<65 & dataset12$Education == "Vocational Diploma"),], 
                             formula= active ~1, weights = weight)

age_diploma_low_labour <- lm(data=dataset12[(dataset12$ag<65 & dataset12$Education == "High School or Lower"),], 
                             formula= active ~1, weights = weight)


results_diploma <- data.frame(
  Category = rep(c("Unemployed", "Labour Force"), each = 3),  # Categories for unemployment and labour force
  EducationLevel = rep(c("Higher than BAC", "Vocational Diploma", "High School or Lower"), times = 2),  
  
  Share = c(
    coef(age_diploma_high)[1],  # Higher than BAC: Unemployment
    coef(age_diploma_voc)[1],   # Vocational Diploma: Unemployment
    coef(age_diploma_low)[1],   # High School or Lower: Unemployment
    coef(age_diploma_high_labour)[1],  # Higher than BAC: Labour Force
    coef(age_diploma_voc_labour)[1],  # Vocational Diploma: Labour Force
    coef(age_diploma_low_labour)[1]   # High School or Lower: Labour Force
  )
)


results_diploma_long <- results_diploma %>%
  gather(key = "Variable", value = "Value", Share)


plot3 <- ggplot(results_diploma_long, aes(x = EducationLevel, y = (100 * Value), fill = Category)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.7) +  
  
  labs(title = "Unemployment and Labour Force Rates % by Education Level 2012", 
       x = "Education Level", 
       y = "Rates (%)",
       fill = "Category") +
  scale_fill_manual(values = c("Unemployed" = "lightgoldenrod1", "Labour Force" = "burlywood")) +
  theme_minimal() +
  theme(
    legend.position = "right",
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    axis.title = element_text(size = 12)
  ) +
  theme(
    plot.title = element_text(size = 8),     
    plot.subtitle = element_text(size = 7),  
    plot.caption = element_text(size = 7),
    axis.title.x = element_text(size = 6),
    axis.title.y = element_text(size = 6),
    legend.text = element_text(size = 6),
    legend.title = element_text(size = 7)
  )


high_diploma <- huxreg("Unemployment" = age_diploma_high, "Labour Force" = age_diploma_high_labour,
                       statistics = c(N = "nobs"), coefs = c("Higher than BAC:" = "(Intercept)"), note = NULL)

vocational_diploma <- huxreg("Unemployment" = age_diploma_voc, "Labour Force" = age_diploma_voc_labour,
                             statistics = c(N = "nobs"), coefs = c("Vocational Diploma:" = "(Intercept)"), note = NULL)

low_diploma <- huxreg("Unemployment" = age_diploma_low, "Labour Force" = age_diploma_low_labour,
                     statistics = c(N = "nobs"), coefs = c("High School or Lower:" = "(Intercept)"), note = NULL)

# Combine the tables for output (only selecting relevant rows)
table_diploma <- rbind(
  high_diploma[1:3,],          # Select Unemployment and Labour Force for Higher than BAC
  vocational_diploma[2:3,],    # Select Unemployment and Labour Force for Vocational Diploma
  low_diploma[2:3,]           # Select Unemployment and Labour Force for High School or Lower
)

caption(table_diploma) <- c("Rates by Education Level 2012")


set_latex_float(table_diploma, "H")

```

To obtain picture of the difference in labour force participation and unemployment rates across demographic characteristics we plot the relative rates.

```{r, fig.width=4, fig.height=5}

results_diploma <- data.frame(
  Category = rep(c("Unemployed", "Labour Force"), each = 2),  
  
  EducationLevel = rep(c("Lower or no Diploma", "Higher Diploma"), times = 2), 
  
  Share = c(
    coef(age_diploma_low)[1],  # Low diploma: Unemployment
    coef(age_diploma_high)[1],  # High diploma: Unemployment
    coef(age_diploma_low_labour)[1],  # Low diploma: Labour Force
    coef(age_diploma_high_labour)[1]   # High diploma: Labour Force
  )
)

# Pivot the data to long format
results_diploma_long <- results_diploma %>%
  gather(key = "Variable", value = "Value", Share)

plot3 <- ggplot(results_diploma_long, aes(x = EducationLevel, y = (100 * Value), fill = Category)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.7) +  # Use "dodge" for side-by-side bars
  labs(title = "Unemployment and Labour Force Rates % by Education Level 2012", 
       x = "Education Level", 
       y = "Rate (%)",
       fill = "Category") +
  scale_fill_manual(values = c("Unemployed" = "lightgoldenrod1", "Labour Force" = "burlywood")) +
  theme_minimal() +
  theme(
    legend.position = "right",
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    axis.title = element_text(size = 12)
  ) +
  theme(
    plot.title = element_text(size = 8),     
    plot.subtitle = element_text(size = 7),  
    plot.caption = element_text(size = 7),
    axis.title.x = element_text(size = 6),
    axis.title.y = element_text(size = 6),
    legend.text = element_text(size = 6),
    legend.title = element_text(size = 7)
  )

grid.arrange(plot1, plot2, plot3, ncol=1)
```

```{r}

table8<- rbind(table_women[1:5,], table_age[2:5,], table_diploma[2:7,])
caption(table8) <- c("Rates by demographics")
table8
```

\newpage

## Complete Code

```{r ref.label=all_labels(), echo=T, eval=FALSE}


```

